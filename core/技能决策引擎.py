"""
技能决策引擎
包含具体的技能循环策略实现
"""
from typing import Dict, Any
from core.技能循环策略 import 技能循环策略


class 默认循环策略(技能循环策略):
    """默认技能循环策略"""
    
    def 推算技能(self, 技能状态检测器, 图像获取接口, 技能字典: Dict[str, Any], 
                气劲字典: Dict[str, Any], 蓝条配置: Dict[str, Any], 
                检测区域: tuple, 七情和合状态: int) -> int:
        """
        默认模式下的技能推算逻辑
        """
        键值 = 0
        
        # 获取屏幕图像
        图片 = 图像获取接口.获取屏幕区域(检测区域)
        
        # 判断当前蓝量
        蓝量 = 技能状态检测器.判断蓝量状态(图片, 蓝条配置)
        
        # 判断千枝气劲状态
        千枝开启 = 技能状态检测器.判断气劲状态(图片, 气劲字典.get("千枝状态"))
        
        # 千枝气劲开启时的逻辑
        if 千枝开启 == 1:
            if 七情和合状态 == 1:
                # 判断七情气劲是否开启
                七情开启 = 技能状态检测器.判断气劲状态(图片, 气劲字典.get("七情状态"))
                if 七情开启 == 0:
                    键值 = 技能状态检测器.判断素柯技能可用性(
                        图片, 技能字典.get("七情和合"), 气劲字典.get("素柯状态"))
                    # 如果七情技能正在CD则取消循环中的七情
                    if 键值 == 0:
                        七情和合状态 = 0
                else:
                    # 如果七情被动已亮则取消循环中的七情
                    七情和合状态 = 0
            
            if 键值 <= 0:
                键值 = 技能状态检测器.判断素柯技能可用性(
                    图片, 技能字典.get("赤芍寒香"), 气劲字典.get("素柯状态"))
            
            if 键值 <= 0:
                键值 = 技能状态检测器.判断气劲技能可用性(图片, 气劲字典.get("千枝状态"))
        
        # 千枝气劲关闭时的逻辑
        else:
            if 七情和合状态 == 1:
                七情开启 = 技能状态检测器.判断气劲状态(图片, 气劲字典.get("七情状态"))
                if 七情开启 == 0:
                    键值 = 技能状态检测器.判断素柯技能可用性(
                        图片, 技能字典.get("七情和合"), 气劲字典.get("素柯状态"))
                    if 蓝量 == 1:
                        if 键值 > 0:
                            键值 = 技能状态检测器.判断素柯技能可用性(
                                图片, 技能字典.get("千枝绽蕊"), 气劲字典.get("素柯状态"))
                    else:
                        if 键值 == 0:
                            七情和合状态 = 0
                else:
                    七情和合状态 = 0
        
        # 通用技能优先级顺序
        if 键值 == 0:
            键值 = 技能状态检测器.判断素柯技能可用性(
                图片, 技能字典.get("青川濯莲"), 气劲字典.get("素柯状态"))
        
        if 键值 == 0:
            键值 = 技能状态检测器.判断素柯技能可用性(
                图片, 技能字典.get("逐云寒蕊"), 气劲字典.get("素柯状态"))
        
        if 键值 == 0:
            键值 = 技能状态检测器.判断普通技能可用性(图片, 技能字典.get("当归四逆"))
        
        if 键值 == 0:
            键值 = 技能状态检测器.判断素柯技能可用性(
                图片, 技能字典.get("银光照雪"), 气劲字典.get("素柯状态"))
        
        if 键值 == 0:
            键值 = 技能状态检测器.判断素柯技能可用性(
                图片, 技能字典.get("赤芍寒香"), 气劲字典.get("素柯状态"))
            # 确认可以释放赤芍寒香则先释放千枝绽蕊
            if 键值 > 0 and 蓝量 == 1:
                键值 = 技能状态检测器.判断素柯技能可用性(
                    图片, 技能字典.get("千枝绽蕊"), 气劲字典.get("素柯状态"))
        
        if 键值 == 0:
            键值 = 技能状态检测器.判断素柯技能可用性(
                图片, 技能字典.get("绿野蔓生"), 气劲字典.get("素柯状态"))
        
        if 键值 == 0:
            键值 = 技能状态检测器.判断素柯技能可用性(
                图片, 技能字典.get("白芷含芳"), 气劲字典.get("素柯状态"))
        
        return 键值


class 驱散循环策略(技能循环策略):
    """驱散技能循环策略"""
    
    def 推算技能(self, 技能状态检测器, 图像获取接口, 技能字典: Dict[str, Any], 
                气劲字典: Dict[str, Any], 蓝条配置: Dict[str, Any], 
                检测区域: tuple, 七情和合状态: int) -> int:
        """
        驱散模式下的技能推算逻辑
        与默认模式类似，但技能优先级略有不同
        """
        键值 = 0
        
        # 获取屏幕图像
        图片 = 图像获取接口.获取屏幕区域(检测区域)
        
        # 判断当前蓝量
        蓝量 = 技能状态检测器.判断蓝量状态(图片, 蓝条配置)
        
        # 判断千枝气劲状态
        千枝开启 = 技能状态检测器.判断气劲状态(图片, 气劲字典.get("千枝状态"))
        
        # 千枝气劲开启时的逻辑
        if 千枝开启 == 1:
            if 七情和合状态 == 1:
                七情开启 = 技能状态检测器.判断气劲状态(图片, 气劲字典.get("七情状态"))
                if 七情开启 == 0:
                    键值 = 技能状态检测器.判断素柯技能可用性(
                        图片, 技能字典.get("七情和合"), 气劲字典.get("素柯状态"))
                    if 键值 == 0:
                        七情和合状态 = 0
                else:
                    七情和合状态 = 0
            
            if 键值 <= 0:
                键值 = 技能状态检测器.判断素柯技能可用性(
                    图片, 技能字典.get("赤芍寒香"), 气劲字典.get("素柯状态"))
            
            if 键值 <= 0:
                键值 = 技能状态检测器.判断气劲技能可用性(图片, 气劲字典.get("千枝状态"))
        
        # 千枝气劲关闭时的逻辑
        else:
            if 七情和合状态 == 1:
                七情开启 = 技能状态检测器.判断气劲状态(图片, 气劲字典.get("七情状态"))
                if 七情开启 == 0:
                    键值 = 技能状态检测器.判断素柯技能可用性(
                        图片, 技能字典.get("七情和合"), 气劲字典.get("素柯状态"))
                    if 蓝量 == 1:
                        if 键值 > 0:
                            键值 = 技能状态检测器.判断素柯技能可用性(
                                图片, 技能字典.get("千枝绽蕊"), 气劲字典.get("素柯状态"))
                    else:
                        if 键值 == 0:
                            七情和合状态 = 0
                else:
                    七情和合状态 = 0
        
        # 驱散模式下的技能优先级
        if 键值 == 0:
            键值 = 技能状态检测器.判断素柯技能可用性(
                图片, 技能字典.get("青川濯莲"), 气劲字典.get("素柯状态"))
        
        if 键值 == 0:
            键值 = 技能状态检测器.判断素柯技能可用性(
                图片, 技能字典.get("逐云寒蕊"), 气劲字典.get("素柯状态"))
        
        if 键值 == 0:
            键值 = 技能状态检测器.判断素柯技能可用性(
                图片, 技能字典.get("赤芍寒香"), 气劲字典.get("素柯状态"))
            if 键值 > 0 and 蓝量 == 1:
                键值 = 技能状态检测器.判断素柯技能可用性(
                    图片, 技能字典.get("千枝绽蕊"), 气劲字典.get("素柯状态"))
        
        if 键值 == 0:
            键值 = 技能状态检测器.判断素柯技能可用性(
                图片, 技能字典.get("绿野蔓生"), 气劲字典.get("素柯状态"))
        
        if 键值 == 0:
            键值 = 技能状态检测器.判断素柯技能可用性(
                图片, 技能字典.get("白芷含芳"), 气劲字典.get("素柯状态"))
        
        return 键值


class 技能决策引擎:
    """技能决策引擎，管理不同策略"""
    
    def __init__(self):
        self.策略映射 = {
            1: 默认循环策略(),  # 默认循环模式
            2: 驱散循环策略(),  # 驱散循环模式
        }
        self.七情和合状态 = 0  # 七情和合状态标记
    
    def 推算技能(self, 模式: int, 技能状态检测器, 图像获取接口, 技能字典: Dict[str, Any], 
                气劲字典: Dict[str, Any], 蓝条配置: Dict[str, Any], 检测区域: tuple) -> int:
        """
        根据模式推算技能
        
        参数:
            模式: 技能循环模式
            其他参数同策略接口
            
        返回:
            int: 技能键值
        """
        策略 = self.策略映射.get(模式)
        if not 策略:
            return 0
        
        return 策略.推算技能(
            技能状态检测器, 图像获取接口, 技能字典, 气劲字典, 
            蓝条配置, 检测区域, self.七情和合状态
        )
    
    def 设置七情和合状态(self, 状态: int):
        """设置七情和合状态"""
        self.七情和合状态 = 状态
    
    def 获取七情和合状态(self) -> int:
        """获取七情和合状态"""
        return self.七情和合状态