"""
可插拔的策略接口
支持运行时策略切换和扩展
"""
from typing import Dict, Any, List, Protocol, Tuple, Optional
from abc import ABC, abstractmethod
from enum import Enum
from utils.时间戳优化器 import 获取优化时间

# 避免循环引用，使用 TYPE_CHECKING
from typing import TYPE_CHECKING
if TYPE_CHECKING:
    from core.状态监测器 import 状态监测器


class 循环模式(Enum):
    """技能循环模式枚举"""
    默认循环 = 1
    驱散循环 = 2
    PVE模式 = 3
    PVP模式 = 4
    竞速模式 = 5


class 技能策略接口(Protocol):
    """技能策略接口协议"""
    
    def 获取策略名称(self) -> str:
        """获取策略名称"""
        ...
    
    def 获取策略描述(self) -> str:
        """获取策略描述"""
        ...
    
    def 获取支持模式(self) -> List[循环模式]:
        """获取支持的循环模式"""
        ...
    
    def 推算技能(self, 上下文: '策略上下文') -> int:
        """推算要释放的技能"""
        ...


class 策略上下文:
    """策略执行上下文（性能优化版）"""
    
    def __init__(self, 技能状态检测器: Any, 图像获取接口: Any, 状态监测器: Any, 
                技能字典: Dict[str, Any], 气劲字典: Dict[str, Any], 蓝条配置: Dict[str, Any], 
                检测区域: Tuple[int, int, int, int], 七情和合状态: int,
                目标状态配置: Optional[Dict[str, Any]] = None) -> None:
        # 使用弱引用避免循环引用
        self.技能状态检测器 = 技能状态检测器
        self.图像获取接口 = 图像获取接口
        self.状态监测器 = 状态监测器
        
        # 懒加载数据：仅在需要时创建副本
        self._技能字典 = 技能字典
        self._气劲字典 = 气劲字典
        self._蓝条配置 = 蓝条配置
        self.检测区域 = 检测区域
        self.七情和合状态 = 七情和合状态
        self.目标状态配置 = 目标状态配置 or {}
        
        # 缓存图像，避免重复获取
        self._缓存图像 = None
        self._缓存时间 = 0
        self.缓存有效期 = 0.05  # 优化：缩短到50毫秒
        
        # 缓存目标状态
        self._目标HP = None
        self._目标Buffs = None
        self._目标Debuffs = None
        
        # 性能优化：懒加载数据副本
        self._技能字典副本 = None
        self._气劲字典副本 = None
        self._蓝条配置副本 = None
        
        # 使用统计
        self._图像获取次数 = 0
        self._字典访问次数 = 0
    
    @property
    def 技能字典(self) -> Dict[str, Any]:
        """懒加载技能字典副本"""
        self._字典访问次数 += 1
        if self._技能字典副本 is None:
            # 仅在需要时创建副本
            self._技能字典副本 = self._技能字典.copy()
        return self._技能字典副本
    
    @property
    def 气劲字典(self) -> Dict[str, Any]:
        """懒加载气劲字典副本"""
        self._字典访问次数 += 1
        if self._气劲字典副本 is None:
            self._气劲字典副本 = self._气劲字典.copy()
        return self._气劲字典副本
    
    @property
    def 蓝条配置(self) -> Dict[str, Any]:
        """懒加载蓝条配置副本"""
        self._字典访问次数 += 1
        if self._蓝条配置副本 is None:
            self._蓝条配置副本 = self._蓝条配置.copy()
        return self._蓝条配置副本
    
    def 获取屏幕图像(self) -> Any:
        """获取屏幕图像（带缓存优化）"""
        self._图像获取次数 += 1
        当前时间 = 获取优化时间()
        
        # 优化缓存策略
        if (self._缓存图像 is None or 
            (当前时间 - self._缓存时间) > self.缓存有效期 or
            self._图像获取次数 % 3 == 0):  # 每3次强制刷新一次
            self._缓存图像 = self.图像获取接口.获取屏幕区域(self.检测区域)
            self._缓存时间 = 当前时间
        
        return self._缓存图像
    
    def 获取性能统计(self) -> Dict[str, Any]:
        """获取上下文性能统计"""
        return {
            "图像获取次数": self._图像获取次数,
            "字典访问次数": self._字典访问次数,
            "缓存命中率": f"{(self._图像获取次数 - 3) / max(self._图像获取次数, 1):.2%}",
            "缓存有效期": f"{self.缓存有效期}秒"
        }
    
    def 重置性能统计(self):
        """重置性能统计"""
        self._图像获取次数 = 0
        self._字典访问次数 = 0

    @property
    def 目标HP(self) -> float:
        """获取目标HP百分比（懒加载）"""
        if self._目标HP is None:
            血条区域 = self.目标状态配置.get("血条区域")
            颜色阈值 = self.目标状态配置.get("血条颜色阈值")
            if hasattr(self.状态监测器, '获取目标HP百分比'):
                self._目标HP = self.状态监测器.获取目标HP百分比(血条区域, 颜色阈值)
            else:
                self._目标HP = 1.0 # 默认满血
        return self._目标HP

    @property
    def 目标Buffs(self) -> List[str]:
        """获取目标Buff列表（懒加载）"""
        if self._目标Buffs is None:
            Buff区域 = self.目标状态配置.get("Buff区域")
            Buff名称列表 = self.目标状态配置.get("关注Buff列表", [])
            模板路径字典 = self.目标状态配置.get("Buff模板路径", {})
            if hasattr(self.状态监测器, '检测Buff状态'):
                self._目标Buffs = self.状态监测器.检测Buff状态(Buff区域, Buff名称列表, 模板路径字典)
            else:
                self._目标Buffs = []
        return self._目标Buffs

    @property
    def 目标Debuffs(self) -> List[str]:
        """获取目标Debuff列表（懒加载）"""
        if self._目标Debuffs is None:
            Debuff区域 = self.目标状态配置.get("Debuff区域")
            Debuff名称列表 = self.目标状态配置.get("关注Debuff列表", [])
            模板路径字典 = self.目标状态配置.get("Debuff模板路径", {})
            if hasattr(self.状态监测器, '检测Debuff状态'):
                self._目标Debuffs = self.状态监测器.检测Debuff状态(Debuff区域, Debuff名称列表, 模板路径字典)
            else:
                self._目标Debuffs = []
        return self._目标Debuffs

    @property
    def 可驱散Debuff列表(self) -> List[str]:
        """获取可驱散Debuff列表"""
        return self.目标状态配置.get("可驱散Debuff列表", [])


class 抽象策略(ABC):
    """抽象策略基类"""
    
    def __init__(self, 策略名称: str, 策略描述: str, 支持模式: List[循环模式]):
        self._策略名称 = 策略名称
        self._策略描述 = 策略描述
        self._支持模式 = 支持模式
    
    def 获取策略名称(self) -> str:
        return self._策略名称
    
    def 获取策略描述(self) -> str:
        return self._策略描述
    
    def 获取支持模式(self) -> List[循环模式]:
        return self._支持模式
    
    @abstractmethod
    def 推算技能(self, 上下文: 策略上下文) -> int:
        """推算要释放的技能"""
        pass


class 默认循环策略(抽象策略):
    """默认技能循环策略"""
    
    def __init__(self):
        super().__init__(
            策略名称="默认循环",
            策略描述="标准PVE治疗循环，平衡治疗和蓝量管理",
            支持模式=[循环模式.默认循环, 循环模式.PVE模式]
        )
    
    def 推算技能(self, 上下文: 策略上下文) -> int:
        """默认模式下的技能推算逻辑"""
        键值 = 0
        
        # 获取屏幕图像（带缓存）
        图片 = 上下文.获取屏幕图像()
        
        # 判断当前蓝量
        蓝量 = 上下文.技能状态检测器.判断蓝量状态(图片, 上下文.蓝条配置)
        
        # 判断千枝气劲状态
        千枝开启 = 上下文.技能状态检测器.判断气劲状态(图片, 上下文.气劲字典.get("千枝状态"))
        
        # 千枝气劲开启时的逻辑
        if 千枝开启 == 1:
            # 优先处理危急血量 (HP < 30%)
            if 上下文.目标HP is not None and 上下文.目标HP < 0.3:
                键值 = 上下文.技能状态检测器.判断普通技能可用性(图片, 上下文.技能字典.get("当归四逆"))
                if 键值 > 0:
                    return 键值

            if 上下文.七情和合状态 == 1:
                # 判断七情气劲是否开启
                七情开启 = 上下文.技能状态检测器.判断气劲状态(图片, 上下文.气劲字典.get("七情状态"))
                if 七情开启 == 0:
                    键值 = 上下文.技能状态检测器.判断素柯技能可用性(
                        图片, 上下文.技能字典.get("七情和合"), 上下文.气劲字典.get("素柯状态"))
                    # 如果七情技能正在CD则取消循环中的七情
                    if 键值 == 0:
                        上下文.七情和合状态 = 0
                else:
                    # 如果七情被动已亮则取消循环中的七情
                    上下文.七情和合状态 = 0
            
            if 键值 <= 0:
                键值 = 上下文.技能状态检测器.判断素柯技能可用性(
                    图片, 上下文.技能字典.get("赤芍寒香"), 上下文.气劲字典.get("素柯状态"))
            
            if 键值 <= 0:
                键值 = 上下文.技能状态检测器.判断气劲技能可用性(图片, 上下文.气劲字典.get("千枝状态"))
        
        # 千枝气劲关闭时的逻辑
        else:
            # 优先处理危急血量 (HP < 30%)
            if 上下文.目标HP is not None and 上下文.目标HP < 0.3:
                键值 = 上下文.技能状态检测器.判断普通技能可用性(图片, 上下文.技能字典.get("当归四逆"))
                if 键值 > 0:
                    return 键值

            if 上下文.七情和合状态 == 1:
                七情开启 = 上下文.技能状态检测器.判断气劲状态(图片, 上下文.气劲字典.get("七情状态"))
                if 七情开启 == 0:
                    键值 = 上下文.技能状态检测器.判断素柯技能可用性(
                        图片, 上下文.技能字典.get("七情和合"), 上下文.气劲字典.get("素柯状态"))
                    if 蓝量 == 1:
                        if 键值 > 0:
                            键值 = 上下文.技能状态检测器.判断素柯技能可用性(
                                图片, 上下文.技能字典.get("千枝绽蕊"), 上下文.气劲字典.get("素柯状态"))
                    else:
                        if 键值 == 0:
                            上下文.七情和合状态 = 0
                else:
                    上下文.七情和合状态 = 0
        
        # 驱散逻辑：检测目标是否有可驱散Debuff
        if 键值 == 0 and 上下文.目标Debuffs:
            for debuff in 上下文.目标Debuffs:
                if debuff in 上下文.可驱散Debuff列表:
                    # 尝试获取 "驱散技能" 或 "清风垂露"
                    驱散技能配置 = 上下文.技能字典.get("驱散技能") or 上下文.技能字典.get("清风垂露")
                    if 驱散技能配置:
                        键值 = 上下文.技能状态检测器.判断普通技能可用性(图片, 驱散技能配置)
                        if 键值 > 0:
                            return 键值

        # 通用技能优先级顺序
        if 键值 == 0:
            键值 = 上下文.技能状态检测器.判断素柯技能可用性(
                图片, 上下文.技能字典.get("青川濯莲"), 上下文.气劲字典.get("素柯状态"))
        
        if 键值 == 0:
            键值 = 上下文.技能状态检测器.判断素柯技能可用性(
                图片, 上下文.技能字典.get("逐云寒蕊"), 上下文.气劲字典.get("素柯状态"))
        
        if 键值 == 0:
            键值 = 上下文.技能状态检测器.判断普通技能可用性(图片, 上下文.技能字典.get("当归四逆"))
        
        if 键值 == 0:
            键值 = 上下文.技能状态检测器.判断素柯技能可用性(
                图片, 上下文.技能字典.get("银光照雪"), 上下文.气劲字典.get("素柯状态"))
        
        if 键值 == 0:
            键值 = 上下文.技能状态检测器.判断素柯技能可用性(
                图片, 上下文.技能字典.get("赤芍寒香"), 上下文.气劲字典.get("素柯状态"))
            # 确认可以释放赤芍寒香则先释放千枝绽蕊
            if 键值 > 0 and 蓝量 == 1:
                键值 = 上下文.技能状态检测器.判断素柯技能可用性(
                    图片, 上下文.技能字典.get("千枝绽蕊"), 上下文.气劲字典.get("素柯状态"))
        
        if 键值 == 0:
            键值 = 上下文.技能状态检测器.判断素柯技能可用性(
                图片, 上下文.技能字典.get("绿野蔓生"), 上下文.气劲字典.get("素柯状态"))
        
        if 键值 == 0:
            键值 = 上下文.技能状态检测器.判断素柯技能可用性(
                图片, 上下文.技能字典.get("白芷含芳"), 上下文.气劲字典.get("素柯状态"))
        
        return 键值


class 驱散循环策略(抽象策略):
    """驱散技能循环策略"""
    
    def __init__(self):
        super().__init__(
            策略名称="驱散循环",
            策略描述="专注于驱散技能的循环模式",
            支持模式=[循环模式.驱散循环]
        )
    
    def 推算技能(self, 上下文: 策略上下文) -> int:
        """驱散模式下的技能推算逻辑"""
        键值 = 0
        
        # 获取屏幕图像（带缓存）
        图片 = 上下文.获取屏幕图像()
        
        # 判断当前蓝量
        蓝量 = 上下文.技能状态检测器.判断蓝量状态(图片, 上下文.蓝条配置)
        
        # 判断千枝气劲状态
        千枝开启 = 上下文.技能状态检测器.判断气劲状态(图片, 上下文.气劲字典.get("千枝状态"))
        
        # 千枝气劲开启时的逻辑
        if 千枝开启 == 1:
            # 优先处理危急血量 (HP < 30%)
            if 上下文.目标HP is not None and 上下文.目标HP < 0.3:
                键值 = 上下文.技能状态检测器.判断普通技能可用性(图片, 上下文.技能字典.get("当归四逆"))
                if 键值 > 0:
                    return 键值

            if 上下文.七情和合状态 == 1:
                七情开启 = 上下文.技能状态检测器.判断气劲状态(图片, 上下文.气劲字典.get("七情状态"))
                if 七情开启 == 0:
                    键值 = 上下文.技能状态检测器.判断素柯技能可用性(
                        图片, 上下文.技能字典.get("七情和合"), 上下文.气劲字典.get("素柯状态"))
                    if 键值 == 0:
                        上下文.七情和合状态 = 0
                else:
                    上下文.七情和合状态 = 0
            
            if 键值 <= 0:
                键值 = 上下文.技能状态检测器.判断素柯技能可用性(
                    图片, 上下文.技能字典.get("赤芍寒香"), 上下文.气劲字典.get("素柯状态"))
            
            if 键值 <= 0:
                键值 = 上下文.技能状态检测器.判断气劲技能可用性(图片, 上下文.气劲字典.get("千枝状态"))
        
        # 千枝气劲关闭时的逻辑
        else:
            # 优先处理危急血量 (HP < 30%)
            if 上下文.目标HP is not None and 上下文.目标HP < 0.3:
                键值 = 上下文.技能状态检测器.判断普通技能可用性(图片, 上下文.技能字典.get("当归四逆"))
                if 键值 > 0:
                    return 键值

            if 上下文.七情和合状态 == 1:
                七情开启 = 上下文.技能状态检测器.判断气劲状态(图片, 上下文.气劲字典.get("七情状态"))
                if 七情开启 == 0:
                    键值 = 上下文.技能状态检测器.判断素柯技能可用性(
                        图片, 上下文.技能字典.get("七情和合"), 上下文.气劲字典.get("素柯状态"))
                    if 蓝量 == 1:
                        if 键值 > 0:
                            键值 = 上下文.技能状态检测器.判断素柯技能可用性(
                                图片, 上下文.技能字典.get("千枝绽蕊"), 上下文.气劲字典.get("素柯状态"))
                    else:
                        if 键值 == 0:
                            上下文.七情和合状态 = 0
                else:
                    上下文.七情和合状态 = 0
        
        # 驱散逻辑：检测目标是否有可驱散Debuff
        if 键值 == 0 and 上下文.目标Debuffs:
            for debuff in 上下文.目标Debuffs:
                if debuff in 上下文.可驱散Debuff列表:
                    # 尝试获取 "驱散技能" 或 "清风垂露"
                    驱散技能配置 = 上下文.技能字典.get("驱散技能") or 上下文.技能字典.get("清风垂露")
                    if 驱散技能配置:
                        键值 = 上下文.技能状态检测器.判断普通技能可用性(图片, 驱散技能配置)
                        if 键值 > 0:
                            return 键值

        # 驱散模式下的技能优先级
        if 键值 == 0:
            键值 = 上下文.技能状态检测器.判断素柯技能可用性(
                图片, 上下文.技能字典.get("青川濯莲"), 上下文.气劲字典.get("素柯状态"))
        
        if 键值 == 0:
            键值 = 上下文.技能状态检测器.判断素柯技能可用性(
                图片, 上下文.技能字典.get("逐云寒蕊"), 上下文.气劲字典.get("素柯状态"))
        
        if 键值 == 0:
            键值 = 上下文.技能状态检测器.判断素柯技能可用性(
                图片, 上下文.技能字典.get("赤芍寒香"), 上下文.气劲字典.get("素柯状态"))
            if 键值 > 0 and 蓝量 == 1:
                键值 = 上下文.技能状态检测器.判断素柯技能可用性(
                    图片, 上下文.技能字典.get("千枝绽蕊"), 上下文.气劲字典.get("素柯状态"))
        
        if 键值 == 0:
            键值 = 上下文.技能状态检测器.判断素柯技能可用性(
                图片, 上下文.技能字典.get("绿野蔓生"), 上下文.气劲字典.get("素柯状态"))
        
        if 键值 == 0:
            键值 = 上下文.技能状态检测器.判断素柯技能可用性(
                图片, 上下文.技能字典.get("白芷含芳"), 上下文.气劲字典.get("素柯状态"))
        
        return 键值


class 策略管理器:
    """策略管理器，支持运行时策略切换"""
    
    def __init__(self):
        self._策略映射: Dict[循环模式, 技能策略接口] = {}
        self._注册策略: Dict[str, 技能策略接口] = {}
        self._当前策略: Optional[技能策略接口] = None
        
        # 注册默认策略
        self.注册策略(默认循环策略())
        self.注册策略(驱散循环策略())
    
    def 注册策略(self, 策略: 技能策略接口):
        """注册策略"""
        self._注册策略[策略.获取策略名称()] = 策略
        
        # 更新模式映射
        for 模式 in 策略.获取支持模式():
            self._策略映射[模式] = 策略
    
    def 设置当前策略(self, 模式: 循环模式) -> bool:
        """设置当前策略"""
        if 模式 in self._策略映射:
            self._当前策略 = self._策略映射[模式]
            return True
        return False
    
    def 获取当前策略(self) -> Optional[技能策略接口]:
        """获取当前策略"""
        return self._当前策略
    
    def 获取可用策略(self) -> List[str]:
        """获取所有可用策略名称"""
        return list(self._注册策略.keys())
    
    def 获取策略信息(self) -> Dict[str, str]:
        """获取所有策略信息"""
        return {名称: 策略.获取策略描述() for 名称, 策略 in self._注册策略.items()}