#!/usr/bin/env python3
"""
增强版示例代码
展示如何使用增强的配置系统和统一的异常处理
"""
import os
from config.配置管理器 import 配置管理器, 配置验证错误
from utils.异常隔离 import 统一异常处理器, 异常处理标准


def 演示增强配置系统():
    """演示增强的配置系统功能"""
    print("=== 增强配置系统演示 ===")
    
    # 创建配置管理器实例
    配置管理器实例 = 配置管理器("./config/", "development")
    
    # 1. 获取当前环境
    print(f"当前环境: {配置管理器实例.获取当前环境()}")
    
    # 2. 验证配置
    try:
        print("配置验证通过")
    except 配置验证错误 as e:
        print(f"配置验证失败: {e}")
    
    # 3. 验证特定技能配置
    技能验证结果 = 配置管理器实例.验证技能配置("青川濯莲")
    print(f"青川濯莲配置验证: {'通过' if 技能验证结果 else '失败'}")
    
    # 4. 获取配置备份
    配置备份 = 配置管理器实例.获取配置备份()
    print(f"配置备份已创建，包含 {len(配置备份['技能配置'])} 个技能配置")
    
    # 5. 添加配置变更回调
    def 配置变更回调(配置管理器):
        print("配置已变更，重新初始化相关组件...")
    
    配置管理器实例.添加配置变更回调(配置变更回调)
    print("配置变更回调已添加")
    
    # 6. 切换到生产环境
    配置管理器实例.设置环境("production")
    print(f"已切换到环境: {配置管理器实例.获取当前环境()}")
    
    print("\n")


def 演示统一异常处理():
    """演示统一的异常处理功能"""
    print("=== 统一异常处理演示 ===")
    
    # 创建统一异常处理器
    异常处理器 = 统一异常处理器("示例模块")
    
    # 模拟会失败的函数
    def 模拟失败函数():
        raise ValueError("这是一个模拟的异常")
    
    def 模拟文件操作():
        # 模拟文件操作
        with open("不存在的文件.txt", "r") as f:
            return f.read()
    
    # 1. 安全执行
    print("1. 安全执行演示:")
    结果1 = 异常处理器.安全执行("模拟操作", 模拟失败函数)
    print(f"安全执行结果: {结果1}")
    
    # 2. 带重试的执行
    print("\n2. 带重试执行演示:")
    结果2 = 异常处理器.带重试执行("文件操作", 模拟文件操作, 最大重试次数=2, 重试间隔=0.5)
    print(f"带重试执行结果: {结果2}")
    
    # 3. 获取异常统计
    print("\n3. 异常统计:")
    统计 = 异常处理器.获取异常统计()
    print(f"总异常数: {统计['总异常数']}")
    print(f"异常类型统计: {统计['按类型统计']}")
    print(f"操作异常统计: {统计['按操作统计']}")
    
    print("\n")


def 演示综合使用():
    """演示配置和异常处理的综合使用"""
    print("=== 综合使用演示 ===")
    
    # 创建异常处理器
    异常处理器 = 统一异常处理器("综合演示")
    
    # 模拟配置相关的操作
    def 加载配置操作():
        配置管理器实例 = 配置管理器("./config/", "development")
        
        # 模拟一些配置操作
        检测区域 = 配置管理器实例.获取检测区域()
        蓝条配置 = 配置管理器实例.获取蓝条配置()
        
        return {
            "检测区域": 检测区域,
            "蓝条配置": 蓝条配置
        }
    
    # 使用异常处理器安全执行配置操作
    配置结果 = 异常处理器.安全执行("加载配置", 加载配置操作)
    
    if 配置结果:
        print("配置加载成功:")
        print(f"检测区域: {配置结果['检测区域']}")
        print(f"蓝条配置: {配置结果['蓝条配置']}")
    else:
        print("配置加载失败")
    
    # 显示异常统计
    统计 = 异常处理器.获取异常统计()
    print(f"\n操作统计: 总异常数={统计['总异常数']}")
    
    print("\n")


def 演示异常处理标准():
    """演示异常处理标准的使用"""
    print("=== 异常处理标准演示 ===")
    
    print("当前异常处理标准:")
    for 键, 值 in 异常处理标准.items():
        print(f"  {键}: {值}")
    
    print("\n使用示例:")
    print(f"默认重试次数: {异常处理标准['最大重试次数']}")
    print(f"默认重试间隔: {异常处理标准['默认重试间隔']}秒")
    print(f"是否记录堆栈: {异常处理标准['是否记录堆栈']}")
    
    print("\n")


if __name__ == "__main__":
    # 设置环境变量（演示用）
    os.environ["APP_ENV"] = "development"
    
    # 执行演示
    演示增强配置系统()
    演示统一异常处理()
    演示综合使用()
    演示异常处理标准()
    
    print("=== 演示完成 ===")