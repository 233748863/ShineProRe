"""
性能监控模块
提供实时性能监控和统计功能
"""
import time
import threading
from typing import Dict, Any, List
from collections import defaultdict, deque
from dataclasses import dataclass
from threading import Lock
from utils.时间戳优化器 import 获取优化时间, 获取优化时间差


@dataclass
class 性能指标:
    """单次操作的性能指标"""
    操作名称: str
    开始时间: float
    结束时间: float = 0.0
    成功: bool = True
    错误信息: str = ""
    
    @property
    def 耗时(self) -> float:
        """计算操作耗时"""
        return self.结束时间 - self.开始时间


class 性能监控器:
    """
    性能监控器
    记录和分析操作性能数据，优化内存使用和统计精度
    """
    
    def __init__(self, 历史记录数量: int = 1000, 启用内存优化: bool = True):
        """
        初始化性能监控器
        
        参数:
            历史记录数量: 保留的历史记录数量
            启用内存优化: 是否启用内存优化
        """
        self.历史记录 = deque(maxlen=历史记录数量)
        self.统计信息 = defaultdict(lambda: {"总次数": 0, "成功次数": 0, "总耗时": 0.0})
        self.锁 = Lock()
        
        # 内存优化设置
        self._启用内存优化 = 启用内存优化
        self._采样率 = 1.0  # 默认采样率
        self._内存使用阈值 = 50 * 1024 * 1024  # 50MB内存阈值
        
        # 滑动窗口实时统计（优化内存使用）
        self._滑动窗口 = deque(maxlen=6000)  # 60秒 * 100次/秒
        self._窗口统计 = {
            "最近1分钟": {"总次数": 0, "成功次数": 0, "总耗时": 0.0},
            "最近5分钟": {"总次数": 0, "成功次数": 0, "总耗时": 0.0}
        }
        
        # 实时统计（兼容旧接口）
        self.实时统计 = {
            "最近1分钟": {"总次数": 0, "成功次数": 0, "平均响应时间": 0.0},
            "最近5分钟": {"总次数": 0, "成功次数": 0, "平均响应时间": 0.0}
        }
        
        # 精确统计（用于高精度计算）
        self._精确统计 = {
            "最近10秒": {"总次数": 0, "成功次数": 0, "总耗时": 0.0, "最小耗时": float('inf'), "最大耗时": 0.0},
            "最近30秒": {"总次数": 0, "成功次数": 0, "总耗时": 0.0, "最小耗时": float('inf'), "最大耗时": 0.0}
        }
        
        # 启动内存监控线程
        if 启用内存优化:
            self._内存监控线程 = threading.Thread(target=self._内存监控循环, daemon=True)
            self._内存监控线程.start()
    
    def _内存监控循环(self):
        """内存监控循环"""
        while True:
            try:
                time.sleep(10)
            except Exception:
                pass

    def 开始记录(self, 操作名称: str) -> 性能指标:
        """
        开始记录一个操作
        
        参数:
            操作名称: 操作的名称
        
        返回:
            性能指标: 性能指标对象
        """
        return 性能指标(操作名称=操作名称, 开始时间=获取优化时间())
    
    def 结束记录(self, 指标: 性能指标, 成功: bool = True, 错误信息: str = ""):
        """
        结束记录一个操作
        
        参数:
            指标: 性能指标对象
            成功: 操作是否成功
            错误信息: 错误信息
        """
        指标.结束时间 = 获取优化时间()
        指标.成功 = 成功
        指标.错误信息 = 错误信息
        
        with self.锁:
            # 记录历史
            self.历史记录.append(指标)
            
            # 更新统计
            统计 = self.统计信息[指标.操作名称]
            统计["总次数"] += 1
            if 成功:
                统计["成功次数"] += 1
            统计["总耗时"] += 指标.耗时
            
            # 更新实时统计（滑动窗口优化）
            self._更新滑动窗口统计(指标)
    
    def _更新滑动窗口统计(self, 指标: 性能指标):
        """更新滑动窗口统计（O(1)复杂度）"""
        当前时间 = 获取优化时间()
        
        # 添加到滑动窗口
        self._滑动窗口.append((当前时间, 指标))
        
        # 增量更新窗口统计
        self._增量更新窗口统计(指标, 当前时间)
        
        # 清理过期数据（每100次操作清理一次，避免频繁清理）
        if len(self._滑动窗口) % 100 == 0:
            self._清理过期窗口数据(当前时间)
    
    def _增量更新窗口统计(self, 指标: 性能指标, 当前时间: float):
        """增量更新窗口统计"""
        # 更新1分钟窗口
        if 当前时间 - 指标.开始时间 <= 60:
            self._窗口统计["最近1分钟"]["总次数"] += 1
            if 指标.成功:
                self._窗口统计["最近1分钟"]["成功次数"] += 1
            self._窗口统计["最近1分钟"]["总耗时"] += 指标.耗时
        
        # 更新5分钟窗口
        if 当前时间 - 指标.开始时间 <= 300:
            self._窗口统计["最近5分钟"]["总次数"] += 1
            if 指标.成功:
                self._窗口统计["最近5分钟"]["成功次数"] += 1
            self._窗口统计["最近5分钟"]["总耗时"] += 指标.耗时
        
        # 更新兼容接口
        self._更新兼容实时统计()
    
    def _清理过期窗口数据(self, 当前时间: float):
        """清理过期窗口数据"""
        # 清理1分钟前的数据
        一分钟前 = 当前时间 - 60
        
        # 从滑动窗口前端清理过期数据
        while self._滑动窗口 and self._滑动窗口[0][0] < 一分钟前:
            过期时间, 过期指标 = self._滑动窗口.popleft()
            
            # 从统计中减去过期数据
            self._窗口统计["最近1分钟"]["总次数"] -= 1
            if 过期指标.成功:
                self._窗口统计["最近1分钟"]["成功次数"] -= 1
            self._窗口统计["最近1分钟"]["总耗时"] -= 过期指标.耗时
            
            # 如果也超过5分钟，从5分钟窗口减去
            if 过期时间 < 当前时间 - 300:
                self._窗口统计["最近5分钟"]["总次数"] -= 1
                if 过期指标.成功:
                    self._窗口统计["最近5分钟"]["成功次数"] -= 1
                self._窗口统计["最近5分钟"]["总耗时"] -= 过期指标.耗时
    
    def _更新兼容实时统计(self):
        """更新兼容旧接口的实时统计"""
        # 1分钟窗口
        一分钟统计 = self._窗口统计["最近1分钟"]
        总次数1 = 一分钟统计["总次数"]
        成功次数1 = 一分钟统计["成功次数"]
        总耗时1 = 一分钟统计["总耗时"]
        
        self.实时统计["最近1分钟"] = {
            "总次数": 总次数1,
            "成功次数": 成功次数1,
            "成功率": 成功次数1 / 总次数1 if 总次数1 > 0 else 0.0,
            "平均响应时间": 总耗时1 / 总次数1 if 总次数1 > 0 else 0.0
        }
        
        # 5分钟窗口
        五分钟统计 = self._窗口统计["最近5分钟"]
        总次数5 = 五分钟统计["总次数"]
        成功次数5 = 五分钟统计["成功次数"]
        总耗时5 = 五分钟统计["总耗时"]
        
        self.实时统计["最近5分钟"] = {
            "总次数": 总次数5,
            "成功次数": 成功次数5,
            "成功率": 成功次数5 / 总次数5 if 总次数5 > 0 else 0.0,
            "平均响应时间": 总耗时5 / 总次数5 if 总次数5 > 0 else 0.0
        }
    
    def _更新实时统计(self, 指标: 性能指标):
        """更新实时统计信息（兼容旧方法）"""
        # 现在使用滑动窗口统计，此方法保持兼容性
        pass
    
    def _计算时间窗口统计(self, 开始时间: float) -> Dict[str, Any]:
        """计算指定时间窗口内的统计"""
        总次数 = 0
        成功次数 = 0
        总耗时 = 0.0
        
        for 指标 in self.历史记录:
            if 指标.开始时间 >= 开始时间:
                总次数 += 1
                if 指标.成功:
                    成功次数 += 1
                总耗时 += 指标.耗时
        
        平均响应时间 = 总耗时 / 总次数 if 总次数 > 0 else 0.0
        
        return {
            "总次数": 总次数,
            "成功次数": 成功次数,
            "成功率": 成功次数 / 总次数 if 总次数 > 0 else 0.0,
            "平均响应时间": 平均响应时间
        }
    
    def 获取操作统计(self, 操作名称: str = None) -> Dict[str, Any]:
        """
        获取操作统计信息
        
        参数:
            操作名称: 特定操作的名称，None表示所有操作
        
        返回:
            dict: 统计信息
        """
        with self.锁:
            if 操作名称:
                统计 = self.统计信息.get(操作名称, {"总次数": 0, "成功次数": 0, "总耗时": 0.0})
                
                总次数 = 统计["总次数"]
                成功次数 = 统计["成功次数"]
                总耗时 = 统计["总耗时"]
                
                return {
                    "操作名称": 操作名称,
                    "总次数": 总次数,
                    "成功次数": 成功次数,
                    "成功率": 成功次数 / 总次数 if 总次数 > 0 else 0.0,
                    "平均响应时间": 总耗时 / 总次数 if 总次数 > 0 else 0.0,
                    "总耗时": 总耗时
                }
            else:
                # 返回所有操作的统计
                所有统计 = {}
                for 操作名称, 统计 in self.统计信息.items():
                    所有统计[操作名称] = {
                        "总次数": 统计["总次数"],
                        "成功次数": 统计["成功次数"],
                        "成功率": 统计["成功次数"] / 统计["总次数"] if 统计["总次数"] > 0 else 0.0,
                        "平均响应时间": 统计["总耗时"] / 统计["总次数"] if 统计["总次数"] > 0 else 0.0
                    }
                return 所有统计
    
    def 生成性能报告(self) -> Dict[str, Any]:
        """
        生成完整的性能报告
        
        返回:
            dict: 性能报告
        """
        with self.锁:
            # 计算总体统计
            总操作次数 = sum(统计["总次数"] for 统计 in self.统计信息.values())
            总成功次数 = sum(统计["成功次数"] for 统计 in self.统计信息.values())
            总耗时 = sum(统计["总耗时"] for 统计 in self.统计信息.values())
            
            return {
                "总体统计": {
                    "总操作次数": 总操作次数,
                    "总成功次数": 总成功次数,
                    "总体成功率": 总成功次数 / 总操作次数 if 总操作次数 > 0 else 0.0,
                    "平均响应时间": 总耗时 / 总操作次数 if 总操作次数 > 0 else 0.0
                },
                "实时统计": self.实时统计,
                "操作统计": self.获取操作统计(),
                "历史记录数量": len(self.历史记录)
            }
    
    def 重置统计(self):
        """重置所有统计信息"""
        with self.锁:
            self.历史记录.clear()
            self.统计信息.clear()
            self.实时统计 = {
                "最近1分钟": {"总次数": 0, "成功次数": 0, "平均响应时间": 0.0},
                "最近5分钟": {"总次数": 0, "成功次数": 0, "平均响应时间": 0.0}
            }


# 全局性能监控器实例
全局监控器 = 性能监控器()


def 监控操作(操作名称: str):
    """
    装饰器：监控函数的执行性能
    
    参数:
        操作名称: 操作的名称
    """
    def 装饰器(函数):
        def 包装器(*args, **kwargs):
            指标 = 全局监控器.开始记录(操作名称)
            try:
                结果 = 函数(*args, **kwargs)
                全局监控器.结束记录(指标, 成功=True)
                return 结果
            except Exception as e:
                全局监控器.结束记录(指标, 成功=False, 错误信息=str(e))
                raise
        return 包装器
    return 装饰器