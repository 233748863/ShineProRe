#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
响应时间自适应调整功能完整测试
验证智能动态优化机制是否正常工作
"""

import time
import random
import sys
import os

# 添加项目路径
sys.path.append(os.path.dirname(os.path.abspath(__file__)))

from 技能循环引擎 import 技能循环引擎

class 响应时间自适应测试器:
    """完整的响应时间自适应调整测试器"""
    
    def __init__(self):
        # 创建测试引擎实例
        self.引擎 = 技能循环引擎()
        
        # 测试统计
        self.测试结果 = {
            "总测试次数": 0,
            "成功次数": 0,
            "失败次数": 0,
            "平均响应时间": 0.0,
            "性能优化记录": [],
            "阈值调整记录": []
        }
        
    def 运行基础功能测试(self) -> bool:
        """测试基础功能是否正常"""
        print("=== 基础功能测试 ===")
        
        # 测试1：获取优化状态
        try:
            优化状态 = self.引擎.获取响应时间优化状态()
            print(f"✓ 优化状态获取成功")
            print(f"  当前阈值: {优化状态['当前阈值']:.3f}s")
            print(f"  自适应间隔: {优化状态['自适应间隔']}")
        except Exception as e:
            print(f"✗ 优化状态获取失败: {e}")
            return False
        
        # 测试2：模拟性能数据
        try:
            # 添加一些测试数据
            for i in range(10):
                响应时间 = random.uniform(0.05, 0.15)
                self.引擎.性能统计["响应时间分布"].append(响应时间)
            
            print(f"✓ 性能数据模拟成功")
        except Exception as e:
            print(f"✗ 性能数据模拟失败: {e}")
            return False
        
        return True
    
    def 运行智能调整测试(self) -> bool:
        """测试智能调整功能"""
        print("\n=== 智能调整功能测试 ===")
        
        # 测试1：智能调整因子计算
        try:
            测试数据 = [0.08, 0.09, 0.1, 0.11, 0.12]
            平均响应时间 = sum(测试数据) / len(测试数据)
            
            调整因子 = self.引擎._计算智能调整因子(平均响应时间)
            print(f"✓ 智能调整因子计算成功: {调整因子:.2f}")
            
            # 验证不同情况下的调整因子
            测试场景 = [
                (0.05, "极好性能"),
                (0.08, "良好性能"),
                (0.12, "正常性能"),
                (0.15, "接近阈值"),
                (0.18, "轻微超时"),
                (0.25, "严重超时")
            ]
            
            for 响应时间, 场景描述 in 测试场景:
                因子 = self.引擎._计算智能调整因子(响应时间)
                print(f"  {场景描述}: {因子:.2f}")
                
        except Exception as e:
            print(f"✗ 智能调整因子测试失败: {e}")
            return False
        
        # 测试2：性能趋势分析
        try:
            # 生成测试数据
            测试数据 = [0.08 + i * 0.005 for i in range(20)]  # 上升趋势
            性能数据 = self.引擎._分析性能趋势()
            
            print(f"✓ 性能趋势分析成功")
            print(f"  趋势: {性能数据['趋势']:.4f}")
            print(f"  稳定性: {性能数据['稳定性']:.4f}")
            print(f"  性能等级: {性能数据['性能等级']}")
            
        except Exception as e:
            print(f"✗ 性能趋势分析测试失败: {e}")
            return False
        
        return True
    
    def 运行多级优化策略测试(self) -> bool:
        """测试多级优化策略"""
        print("\n=== 多级优化策略测试 ===")
        
        # 测试不同性能评分对应的优化级别
        测试场景 = [
            (25, "紧急优化"),
            (45, "重度优化"),
            (65, "中度优化"),
            (75, "轻度优化"),
            (80, "预防性优化"),
            (90, "常规维护")
        ]
        
        for 评分, 期望级别 in 测试场景:
            try:
                # 创建测试性能数据
                测试数据 = {
                    "趋势": 0.005,
                    "稳定性": 0.02,
                    "平均响应时间": 0.12,
                    "波动性": 0.3
                }
                
                优化级别 = self.引擎._确定优化级别(评分, 测试数据)
                print(f"✓ 评分{评分}: {优化级别} (期望: {期望级别})")
                
            except Exception as e:
                print(f"✗ 优化级别测试失败: {e}")
                return False
        
        return True
    
    def 运行完整性能模拟(self, 测试次数: int = 100) -> bool:
        """运行完整的性能模拟测试"""
        print(f"\n=== 完整性能模拟测试 ({测试次数}次) ===")
        
        开始时间 = time.time()
        
        for i in range(测试次数):
            try:
                # 模拟不同性能状况
                if i < 20:
                    # 初期：性能良好
                    响应时间 = random.uniform(0.05, 0.08)
                elif i < 50:
                    # 中期：性能波动
                    响应时间 = random.uniform(0.08, 0.15)
                elif i < 80:
                    # 后期：性能下降
                    响应时间 = random.uniform(0.12, 0.25)
                else:
                    # 恢复期：性能恢复
                    响应时间 = random.uniform(0.06, 0.1)
                
                # 模拟执行
                time.sleep(响应时间 * 0.1)  # 加速测试
                
                # 记录性能数据
                if len(self.引擎.性能统计["响应时间分布"]) >= 100:
                    self.引擎.性能统计["响应时间分布"].pop(0)
                self.引擎.性能统计["响应时间分布"].append(响应时间)
                
                # 更新统计
                self.引擎.执行次数 += 1
                self.引擎.性能统计["总执行时间"] += 响应时间
                self.引擎.性能统计["最小响应时间"] = min(
                    self.引擎.性能统计["最小响应时间"], 响应时间
                )
                self.引擎.性能统计["最大响应时间"] = max(
                    self.引擎.性能统计["最大响应时间"], 响应时间
                )
                
                # 每10次执行一次优化
                if self.引擎.执行次数 % 10 == 0:
                    self.引擎._定期性能优化()
                
                # 记录阈值变化
                当前阈值 = self.引擎._响应时间阈值
                if len(self.测试结果["阈值调整记录"]) == 0 or \
                   self.测试结果["阈值调整记录"][-1]["阈值"] != 当前阈值:
                    self.测试结果["阈值调整记录"].append({
                        "次数": i,
                        "阈值": 当前阈值,
                        "响应时间": 响应时间
                    })
                
                self.测试结果["总测试次数"] += 1
                
                if i % 20 == 0:
                    print(f"  进度: {i}/{测试次数}")
                    
            except Exception as e:
                print(f"✗ 第{i}次测试失败: {e}")
                self.测试结果["失败次数"] += 1
                continue
        
        总耗时 = time.time() - 开始时间
        
        print(f"✓ 完整性能模拟完成")
        print(f"  总耗时: {总耗时:.2f}s")
        print(f"  测试次数: {self.测试结果['总测试次数']}")
        print(f"  失败次数: {self.测试结果['失败次数']}")
        
        return self.测试结果["失败次数"] == 0
    
    def 生成测试报告(self):
        """生成详细的测试报告"""
        print("\n=== 测试报告 ===")
        
        # 获取最终优化状态
        最终状态 = self.引擎.获取响应时间优化状态()
        
        print("最终优化状态:")
        print(f"  当前阈值: {最终状态['当前阈值']:.3f}s")
        print(f"  自适应间隔: {最终状态['自适应调整间隔']}")
        print(f"  连续超时次数: {最终状态['连续超时次数']}")
        
        if 最终状态["性能趋势"] != "数据不足":
            print(f"  性能趋势: {最终状态['性能趋势']['趋势']:.4f}")
            print(f"  稳定性: {最终状态['性能趋势']['稳定性']:.4f}")
            print(f"  性能等级: {最终状态['性能趋势']['性能等级']}")
        
        # 阈值调整历史
        print("\n阈值调整历史:")
        for 记录 in self.测试结果["阈值调整记录"]:
            print(f"  次数{记录['次数']}: 阈值={记录['阈值']:.3f}s, 响应时间={记录['响应时间']:.3f}s")
        
        # 性能统计
        if self.引擎.性能统计["响应时间分布"]:
            平均响应时间 = sum(self.引擎.性能统计["响应时间分布"]) / len(self.引擎.性能统计["响应时间分布"])
            print(f"\n性能统计:")
            print(f"  平均响应时间: {平均响应时间:.3f}s")
            print(f"  最小响应时间: {self.引擎.性能统计['最小响应时间']:.3f}s")
            print(f"  最大响应时间: {self.引擎.性能统计['最大响应时间']:.3f}s")
            print(f"  样本数量: {len(self.引擎.性能统计['响应时间分布'])}")
    
    def 运行所有测试(self) -> bool:
        """运行所有测试"""
        print("开始响应时间自适应调整功能测试...")
        
        # 测试1：基础功能
        if not self.运行基础功能测试():
            return False
        
        # 测试2：智能调整功能
        if not self.运行智能调整测试():
            return False
        
        # 测试3：多级优化策略
        if not self.运行多级优化策略测试():
            return False
        
        # 测试4：完整性能模拟
        if not self.运行完整性能模拟(50):  # 减少测试次数以加快速度
            return False
        
        # 生成报告
        self.生成测试报告()
        
        print("\n=== 测试完成 ===")
        return True

if __name__ == "__main__":
    # 创建测试器
    测试器 = 响应时间自适应测试器()
    
    # 运行所有测试
    成功 = 测试器.运行所有测试()
    
    if 成功:
        print("\n🎉 所有测试通过！响应时间自适应调整功能正常工作。")
        sys.exit(0)
    else:
        print("\n❌ 测试失败！请检查代码实现。")
        sys.exit(1)