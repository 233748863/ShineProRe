# 技能循环引擎 - API参考文档

## 概述

本文档详细描述了技能循环引擎的所有公共API接口，包括类、方法、参数和返回值。

## 核心类 API

### 技能循环引擎类

**类名**：`技能循环引擎`
**位置**：`技能循环引擎.py`
**描述**：主要的技能循环引擎入口类，提供完整的技能循环功能。

#### 构造函数

```python
def __init__(self, 容器=None, 配置路径: str = "./config/", 
             按键接口: 按键操作接口 = None, 图像接口: 图像获取接口 = None,
             环境: str = None)
```

**参数**：
- `容器`：依赖容器实例，None则自动创建
- `配置路径`：配置文件目录路径
- `按键接口`：按键操作接口实例（可选，容器优先）
- `图像接口`：图像获取接口实例（可选，容器优先）
- `环境`：运行环境（development/production），None则自动检测

**示例**：
```python
引擎 = 技能循环引擎(
    配置路径="./config/",
    按键接口=我的按键适配器(),
    图像接口=我的图像适配器()
)
```

#### 主要方法

##### 注册新策略
```python
def 注册新策略(self, 策略实例)
```

**参数**：
- `策略实例`：实现技能策略接口的实例

**功能**：注册新的策略实现，支持运行时策略扩展。

##### 获取可用策略
```python
def 获取可用策略(self) -> Dict[str, str]
```

**返回**：
- `Dict[str, str]`：{策略名称: 策略描述}

**功能**：获取所有可用策略信息。

##### 设置循环模式
```python
def 设置循环模式(self, 模式: 循环模式)
```

**参数**：
- `模式`：循环模式枚举值

**功能**：设置当前技能循环模式。

**支持的模式**：
- `循环模式.默认循环` (1)
- `循环模式.驱散循环` (2) 
- `循环模式.PVE模式` (3)
- `循环模式.PVP模式` (4)
- `循环模式.竞速模式` (5)

##### 执行一次循环
```python
@需要权限("技能释放")
@监控操作("执行技能循环")
def 执行一次循环(self) -> bool
```

**返回**：
- `bool`：是否成功执行了技能释放

**功能**：执行一次完整的技能循环，集成权限检查、性能监控和异常隔离。

##### 安全执行一次循环
```python
def 安全执行一次循环(self) -> tuple[bool, str]
```

**返回**：
- `tuple[bool, str]`：(是否成功, 错误信息)

**功能**：安全执行一次技能循环，返回详细错误信息。

##### 启用统一异常处理
```python
def 启用统一异常处理(self)
```

**功能**：启用统一异常处理机制。

##### 获取异常统计
```python
def 获取异常统计(self) -> Dict[str, Any]
```

**返回**：
- `Dict[str, Any]`：异常统计信息

**功能**：获取详细的异常统计报告。

##### 设置当前环境
```python
def 设置当前环境(self, 环境: str)
```

**参数**：
- `环境`：运行环境（development/production）

**功能**：手动设置当前运行环境。

##### 设置日志级别
```python
def 设置日志级别(self, 级别: str)
```

**参数**：
- `级别`：日志级别 (调试/信息/警告/错误)

**功能**：设置日志输出级别。

##### 开始配置监听
```python
def 开始配置监听(self)
```

**功能**：开始监听配置文件变化，支持热重载。

##### 停止配置监听
```python
def 停止配置监听(self)
```

**功能**：停止监听配置文件变化。

##### 获取性能报告
```python
def 获取性能报告(self) -> Dict[str, Any]
```

**返回**：
- `Dict[str, Any]`：包含性能统计、权限状态、配置监听状态的完整报告

**功能**：获取完整的性能报告。

##### 检查权限状态
```python
def 检查权限状态(self) -> Dict[str, Any]
```

**返回**：
- `Dict[str, Any]`：权限状态报告

**功能**：检查当前权限状态。

##### 重置性能统计
```python
def 重置性能统计(self)
```

**功能**：重置所有性能统计。

##### 获取当前状态
```python
def 获取当前状态(self) -> Dict[str, Any]
```

**返回**：
- `Dict[str, Any]`：包含引擎状态信息的字典

**功能**：获取当前引擎状态信息。

##### 重新加载配置
```python
def 重新加载配置(self)
```

**功能**：重新加载所有配置文件。

##### 停止循环
```python
def 停止循环(self)
```

**功能**：停止技能循环。

##### 释放所有按键
```python
def 释放所有按键(self)
```

**功能**：释放所有当前按下的按键。

## 策略接口 API

### 循环模式枚举

**枚举名**：`循环模式`
**位置**：`core/策略接口.py`

**枚举值**：
```python
class 循环模式(Enum):
    默认循环 = 1
    驱散循环 = 2
    PVE模式 = 3
    PVP模式 = 4
    竞速模式 = 5
```

### 策略上下文类

**类名**：`策略上下文`
**位置**：`core/策略接口.py`

**构造函数**：
```python
def __init__(self, 技能状态检测器, 图像获取接口, 技能字典: Dict[str, Any], 
            气劲字典: Dict[str, Any], 蓝条配置: Dict[str, Any], 
            检测区域: tuple, 七情和合状态: int)
```

**方法**：

##### 获取屏幕图像
```python
def 获取屏幕图像(self) -> Any
```

**返回**：
- `Any`：屏幕图像对象

**功能**：获取屏幕图像（带缓存机制）。

### 策略管理器类

**类名**：`策略管理器`
**位置**：`core/策略接口.py`

**方法**：

##### 注册策略
```python
def 注册策略(self, 策略: 技能策略接口)
```

**功能**：注册新的策略实现。

##### 设置当前策略
```python
def 设置当前策略(self, 模式: 循环模式) -> bool
```

**返回**：
- `bool`：设置是否成功

**功能**：设置当前使用的策略。

##### 获取当前策略
```python
def 获取当前策略(self) -> Optional[技能策略接口]
```

**返回**：
- `Optional[技能策略接口]`：当前策略实例

**功能**：获取当前使用的策略。

##### 获取可用策略
```python
def 获取可用策略(self) -> List[str]
```

**返回**：
- `List[str]`：所有可用策略名称列表

**功能**：获取所有可用策略名称。

##### 获取策略信息
```python
def 获取策略信息(self) -> Dict[str, str]
```

**返回**：
- `Dict[str, str]`：{策略名称: 策略描述}

**功能**：获取所有策略的详细信息。

## 依赖容器 API

### 依赖容器类

**类名**：`依赖容器`
**位置**：`core/依赖容器.py`

**方法**：

##### 注册单例
```python
def 注册单例(self, 接口类型: Type, 实现实例: Any)
```

**功能**：注册单例实例。

##### 注册工厂
```python
def 注册工厂(self, 接口类型: Type, 工厂函数: Callable)
```

**功能**：注册工厂函数。

##### 注册实现
```python
def 注册实现(self, 接口类型: Type, 实现类型: Type)
```

**功能**：注册接口到实现的映射。

##### 获取实例
```python
def 获取实例(self, 接口类型: Type) -> Any
```

**返回**：
- `Any`：依赖实例

**功能**：获取依赖实例。

##### 清除缓存
```python
def 清除缓存(self)
```

**功能**：清除所有缓存实例。

### 容器工厂类

**类名**：`容器工厂`
**位置**：`core/依赖容器.py`

**静态方法**：

##### 创建默认容器
```python
@staticmethod
def 创建默认容器(配置路径: str = "./config/", 调试模式: bool = False) -> 依赖容器
```

**返回**：
- `依赖容器`：预配置的依赖容器

**功能**：创建默认配置的依赖容器。

## 工具类 API

### 性能监控器类

**类名**：`性能监控器`
**位置**：`utils/性能监控.py`

**方法**：

##### 开始记录
```python
def 开始记录(self, 操作名称: str) -> 性能指标
```

**返回**：
- `性能指标`：性能指标对象

**功能**：开始记录一个操作的性能。

##### 结束记录
```python
def 结束记录(self, 指标: 性能指标, 成功: bool = True, 错误信息: str = "")
```

**功能**：结束记录一个操作。

##### 获取操作统计
```python
def 获取操作统计(self, 操作名称: str = None) -> Dict[str, Any]
```

**返回**：
- `Dict[str, Any]`：操作统计信息

**功能**：获取特定操作或所有操作的统计信息。

##### 生成性能报告
```python
def 生成性能报告(self) -> Dict[str, Any]
```

**返回**：
- `Dict[str, Any]`：完整的性能报告

**功能**：生成完整的性能报告。

##### 重置统计
```python
def 重置统计(self)
```

**功能**：重置所有统计信息。

### 统一异常处理器类

**类名**：`统一异常处理器`
**位置**：`utils/异常隔离.py`

**构造函数**：
```python
def __init__(self, 配置: Dict[str, Any] = None)
```

**方法**：

##### 安全执行
```python
def 安全执行(self, 函数: Callable, *args, **kwargs) -> tuple[bool, Any, str]
```

**返回**：
- `tuple[bool, Any, str]`：(是否成功, 返回值, 错误信息)

**功能**：安全执行函数，捕获所有异常，支持重试机制。

##### 记录异常
```python
def 记录异常(self, 异常类型: str, 异常信息: str, 异常详情: Any = None)
```

**功能**：记录异常信息到统计系统。

##### 获取异常统计
```python
def 获取异常统计(self) -> Dict[str, Any]
```

**返回**：
- `Dict[str, Any]`：异常统计信息

**功能**：获取详细的异常统计报告。

##### 重置异常统计
```python
def 重置异常统计(self)
```

**功能**：重置所有异常统计。

##### 设置重试策略
```python
def 设置重试策略(self, 最大重试次数: int = 3, 重试间隔: float = 1.0)
```

**功能**：设置重试策略参数。

##### 获取异常分类
```python
def 获取异常分类(self, 异常信息: str) -> str
```

**返回**：
- `str`：异常分类（配置异常/权限异常/执行异常/系统异常）

**功能**：根据异常信息自动分类异常类型。

### 异常隔离器类

**类名**：`异常隔离器`
**位置**：`utils/异常隔离.py`

**静态方法**：

##### 安全执行
```python
@staticmethod
def 安全执行(函数: Callable, *args, **kwargs) -> tuple[bool, Any, str]
```

**返回**：
- `tuple[bool, Any, str]`：(是否成功, 返回值, 错误信息)

**功能**：安全执行函数，捕获所有异常。

##### 模块级异常处理
```python
@staticmethod
def 模块级异常处理(函数: Callable) -> Callable
```

**返回**：
- `Callable`：装饰后的函数

**功能**：为函数添加模块级异常处理。

##### 安全上下文管理器
```python
@staticmethod
def 安全上下文管理器()
```

**返回**：
- 安全上下文对象

**功能**：创建安全上下文管理器。

##### 重试机制
```python
@staticmethod
def 重试机制(最大重试次数: int = 3, 重试间隔: float = 1.0)
```

**返回**：
- 装饰器函数

**功能**：为函数添加重试机制。

### 权限控制器类

**类名**：`权限控制器`
**位置**：`utils/权限控制.py`

**方法**：

##### 检查操作权限
```python
def 检查操作权限(self, 操作类型: str) -> tuple[bool, str]
```

**返回**：
- `tuple[bool, str]`：(是否允许, 错误信息)

**功能**：检查操作权限和频率限制。

##### 获取权限状态报告
```python
def 获取权限状态报告(self) -> Dict
```

**返回**：
- `Dict`：权限状态报告

**功能**：获取完整的权限状态报告。

### 配置监听器类

**类名**：`配置监听器`
**位置**：`utils/配置监听器.py`

**方法**：

##### 添加监听
```python
def 添加监听(self, 配置文件: str, 回调函数: Callable)
```

**功能**：添加配置文件监听。

##### 开始监听
```python
def 开始监听(self)
```

**功能**：开始监听配置文件变化。

##### 停止监听
```python
def 停止监听(self)
```

**功能**：停止监听配置文件变化。

##### 手动重载所有配置
```python
def 手动重载所有配置(self)
```

**功能**：手动重载所有监听配置。

##### 获取监听状态
```python
def 获取监听状态(self) -> dict
```

**返回**：
- `dict`：监听器状态信息

**功能**：获取监听器状态。

## 装饰器 API

### 权限检查装饰器

**装饰器**：`需要权限`
**位置**：`utils/权限控制.py`

**用法**：
```python
@需要权限("技能释放")
def 执行一次循环(self) -> bool:
    # 业务逻辑
    pass
```

**功能**：为函数添加权限检查。

### 性能监控装饰器

**装饰器**：`监控操作`
**位置**：`utils/性能监控.py`

**用法**：
```python
@监控操作("执行技能循环")
def 执行一次循环(self) -> bool:
    # 业务逻辑
    pass
```

**功能**：监控函数的执行性能。

### 异常隔离装饰器

**装饰器**：`安全执行技能检测`
**位置**：`utils/异常隔离.py`

**用法**：
```python
@安全执行技能检测
def 安全推算技能(self, 策略, 上下文) -> int:
    # 业务逻辑
    pass
```

**功能**：专门用于技能检测的安全执行。

### 配置热重载装饰器

**装饰器**：`热重载配置`
**位置**：`utils/配置监听器.py`

**用法**：
```python
@热重载配置("技能配置.json")
def 重新加载配置(self):
    # 配置重载逻辑
    pass
```

**功能**：为函数添加配置热重载功能。

## 接口定义 API

### 按键操作接口

**接口名**：`按键操作接口`
**位置**：`interface/按键操作接口.py`

**方法**：

```python
def 按下按键(self, 键值: int) -> bool
def 释放按键(self, 键值: int) -> bool
def 按下并释放(self, 键值: int) -> bool
def 释放所有按键(self) -> bool
```

### 图像获取接口

**接口名**：`图像获取接口`
**位置**：`interface/图像获取接口.py`

**方法**：

```python
def 获取屏幕区域(self, 区域: tuple)
```

### 事件监听接口

**接口名**：`事件监听接口`
**位置**：`interface/事件监听接口.py`

**方法**：

```python
def 开始监听(self)
def 停止监听(self)
def 注册回调(self, 事件类型: str, 回调函数: Callable)
```

## 全局实例 API

### 全局性能监控器

**实例名**：`全局监控器`
**位置**：`utils/性能监控.py`

**类型**：`性能监控器`

### 全局异常隔离器

**实例名**：`全局异常隔离器`
**位置**：`utils/异常隔离.py`

**类型**：`异常隔离器`

### 全局权限控制器

**实例名**：`全局权限控制器`
**位置**：`utils/权限控制.py`

**类型**：`权限控制器`

### 全局配置监听器

**实例名**：`全局配置监听器`
**位置**：`utils/配置监听器.py`

**类型**：`配置监听器`

### 全局日志管理器

**实例名**：`全局日志管理器`
**位置**：`utils/日志管理.py`

**类型**：`日志管理器`

## 错误代码和异常

### 常见异常类型

#### 配置异常
- `FileNotFoundError`：配置文件不存在
- `ValueError`：配置文件格式错误
- `KeyError`：配置项缺失

#### 权限异常
- `PermissionError`：缺少系统权限
- `频率限制异常`：操作频率超限

#### 执行异常
- `RuntimeError`：引擎执行错误
- `异常隔离异常`：安全执行失败

### 错误处理建议

1. **配置错误**：检查配置文件路径和格式
2. **权限错误**：以管理员权限运行程序
3. **执行错误**：查看详细日志信息
4. **性能错误**：调整检测间隔和缓存设置

## 版本兼容性

### API 版本历史

**v1.0.0**：
- 初始版本，基础技能循环功能
- 依赖注入容器支持
- 策略模式框架

**v1.1.0**：
- 添加性能监控系统
- 增强异常处理机制
- 完善权限控制系统

### 向后兼容性

所有公共API在次版本更新中保持向后兼容，重大变更会在主版本更新中明确说明。

---

## 使用示例

### 基本使用示例

```python
from 技能循环引擎 import 技能循环引擎
from interface.按键操作接口 import 按键操作接口
from interface.图像获取接口 import 图像获取接口

class 我的适配器(按键操作接口, 图像获取接口):
    # 实现具体方法
    pass

# 创建引擎实例
引擎 = 技能循环引擎(
    配置路径="./config/",
    按键接口=我的适配器(),
    图像接口=我的适配器()
)

# 设置循环模式
引擎.设置循环模式(循环模式.默认循环)

# 执行循环
for i in range(100):
    引擎.执行一次循环()

# 获取性能报告
报告 = 引擎.获取性能报告()
print(报告)
```

### 高级使用示例

```python
# 注册自定义策略
from core.策略接口 import 抽象策略, 循环模式

class 自定义策略(抽象策略):
    def 推算技能(self, 上下文):
        # 自定义逻辑
        return 技能键值

自定义策略实例 = 自定义策略()
引擎.注册新策略(自定义策略实例)

# 启用配置热重载
引擎.开始配置监听()

# 设置详细日志
引擎.设置日志级别("调试")
```

通过本API参考文档，您可以全面了解技能循环引擎的所有接口功能和使用方法。