# 技能循环引擎 - 快速使用指南

## 概述
这是一个独立的技能循环引擎，可以轻松移植到任何项目中复用技能释放逻辑。

## 目录结构
```
ShineProRe/
├── README.md                 # 详细说明文档
├── docs/                     # 文档文件夹
│   ├── 快速使用指南.md       # 本文件
│   ├── OpenCV版本_小白使用指南.md
│   ├── 模板制作教程_图文版.md
│   ├── 开发人员指南.md
│   ├── API参考文档.md
│   ├── 架构设计说明.md
│   ├── 性能优化报告.md
│   └── 故障排除指南.md
├── 技能循环引擎.py           # 主引擎入口
├── 示例代码_增强版.py        # 增强版示例代码
├── 示例代码.py               # 基础示例代码
├── core/                     # 核心逻辑模块
│   ├── 技能状态检测器.py     # 颜色检测逻辑
│   ├── 技能决策引擎.py       # 优先级决策算法
│   ├── 技能循环策略.py       # 策略模式接口
│   ├── 策略接口.py           # 策略管理器
│   └── 依赖容器.py           # 依赖注入容器
├── interface/                # 抽象接口定义
│   ├── 按键操作接口.py
│   ├── 图像获取接口.py
│   └── 事件监听接口.py
├── config/                   # 配置管理
│   ├── 配置管理器.py         # 增强的配置管理器
│   ├── 配置.development.json # 开发环境配置
│   ├── 配置.production.json  # 生产环境配置
│   └── opencv_技能配置.json  # OpenCV配置示例
└── utils/                    # 工具类
    ├── 颜色判断工具.py
    ├── 性能监控.py           # 性能监控系统
    ├── 异常隔离.py           # 统一异常处理
    ├── 权限控制.py           # 权限管理系统
    ├── 配置监听器.py         # 配置热重载
    ├── 日志管理.py           # 日志管理系统
    ├── 调试工具.py           # 调试支持工具
    ├── 统一缓存管理器.py     # 缓存管理系统
    ├── 时间戳优化器.py       # 性能优化工具
    └── 异步处理.py           # 异步处理工具
```

## 快速集成步骤

### 1. 实现适配器接口
```python
from 技能循环引擎.interface.按键操作接口 import 按键操作接口
from 技能循环引擎.interface.图像获取接口 import 图像获取接口

class 我的按键适配器(按键操作接口):
    def 按下按键(self, 键值: int) -> bool:
        # 调用你的具体按键实现
        return my_keyboard.press(键值)
    
    def 释放按键(self, 键值: int) -> bool:
        return my_keyboard.release(键值)
    
    def 按下并释放(self, 键值: int) -> bool:
        return my_keyboard.press_release(键值)
    
    def 释放所有按键(self) -> bool:
        return my_keyboard.release_all()

class 我的图像适配器(图像获取接口):
    def 获取屏幕区域(self, 区域: tuple):
        # 调用你的截图实现
        return my_screenshot.capture(区域)
```

### 2. 创建引擎实例（支持环境配置）
```python
from 技能循环引擎.技能循环引擎 import 技能循环引擎

# 创建适配器实例
按键适配器 = 我的按键适配器()
图像适配器 = 我的图像适配器()

# 创建引擎实例（支持环境配置）
引擎 = 技能循环引擎(
    配置路径="./config/",  # 配置目录路径
    按键接口=按键适配器,
    图像接口=图像适配器,
    环境="development"  # 可选：development/production，默认自动检测
)

# 或者使用增强版示例代码
from 示例代码_增强版 import 增强版引擎示例
引擎示例 = 增强版引擎示例()
引擎示例.演示增强功能()
```

### 3. 使用引擎（增强功能）
```python
import time

# 设置循环模式 (1=默认循环, 2=驱散循环)
引擎.设置循环模式(1)

# 启用统一异常处理
引擎.启用统一异常处理()

# 启用配置热重载
引擎.开始配置监听()

# 执行技能循环（带异常处理）
for i in range(100):
    成功, 错误信息 = 引擎.安全执行一次循环()
    if not 成功:
        print(f"第{i}次循环失败: {错误信息}")
    time.sleep(0.1)

# 获取性能报告
性能报告 = 引擎.获取性能报告()
print(f"性能报告: {性能报告}")

# 获取异常统计
异常统计 = 引擎.获取异常统计()
print(f"异常统计: {异常统计}")

# 停止循环
引擎.停止循环()
```

## 配置说明

### 环境配置系统
项目现在支持环境特定的配置文件：
- `配置.development.json` - 开发环境配置
- `配置.production.json` - 生产环境配置
- 自动检测当前环境（通过环境变量或系统设置）

### 基本配置 (配置.json)
```json
{
  "检测区域": [x1, y1, x2, y2],
  "蓝条配置": [x1, y1, x2, y2],
  "自动选人键值": 0,
  "环境": "development",
  "异常处理": {
    "启用重试机制": true,
    "最大重试次数": 3,
    "重试间隔": 1.0
  },
  "性能优化": {
    "启用缓存": true,
    "缓存有效期": 0.1,
    "采样间隔": 0.01
  }
}
```

### 技能配置 (opencv_技能配置.json)
```json
{
  "技能名称": {
    "键值": 按键码,
    "颜色": [R, G, B],
    "坐标": [x, y],
    "蓝量需求": 数值,
    "优先级": 数值,
    "异常处理策略": "重试|跳过|停止"
  }
}
```

### 配置验证和回调
```python
# 配置验证回调示例
def 配置验证回调(配置数据):
    """自定义配置验证逻辑"""
    if not 配置数据.get("检测区域"):
        raise ValueError("检测区域配置缺失")
    return True

# 配置变更回调示例
def 配置变更回调(变更类型, 配置键, 旧值, 新值):
    """配置变更时的回调函数"""
    print(f"配置变更: {变更类型} {配置键} {旧值} -> {新值}")
```

## 核心功能（增强版）

### 技能优先级算法
- **千枝气劲开启时**: 七情和合 > 赤芍寒香 > 关闭千枝
- **千枝气劲关闭时**: 七情和合 > 千枝绽蕊 > 其他技能
- **通用技能顺序**: 青川濯莲 > 逐云寒蕊 > 当归四逆 > 银光照雪 > 赤芍寒香 > 绿野蔓生 > 白芷含芳

### 状态检测
- 颜色检测：基于像素点的技能状态判断
- 蓝量检测：智能蓝量管理
- 气劲状态检测：气劲开启/关闭状态判断

### 新增功能特性

#### 1. 统一异常处理
- **异常分类**: 配置异常、权限异常、执行异常、系统异常
- **重试机制**: 自动重试失败的操作
- **异常统计**: 详细的异常类型和频率统计
- **安全执行**: 所有操作都经过异常隔离

#### 2. 环境配置管理
- **环境检测**: 自动识别开发/生产环境
- **配置继承**: 基础配置 + 环境特定配置
- **热重载**: 运行时配置更新
- **配置验证**: 自动验证配置格式和完整性

#### 3. 性能优化系统
- **时间戳优化器**: 减少系统调用开销
- **统一缓存管理**: 多级缓存策略
- **滑动窗口统计**: O(1)复杂度的实时统计
- **性能监控**: 详细的性能指标和报告

#### 4. 安全增强
- **权限装饰器**: 方法级权限控制
- **频率限制**: 防止过度操作
- **异常隔离**: 模块级错误处理
- **安全上下文**: 资源自动释放

## 移植注意事项

1. **接口适配**: 需要为你的项目实现具体的适配器接口
2. **配置调整**: 根据实际游戏界面调整配置参数
3. **性能优化**: 控制截图频率，避免频繁计算
4. **错误处理**: 引擎包含完善的异常处理机制
5. **环境配置**: 设置合适的环境配置文件
6. **异常处理**: 根据需求配置异常处理策略

## 示例代码

查看以下文件了解完整的集成示例：
- `技能循环引擎.py` - 基础示例代码
- `示例代码_增强版.py` - 增强版功能演示
- `opencv_示例代码_优化版.py` - OpenCV优化版本

## 新增功能演示

### 统一异常处理演示
```python
from utils.异常隔离 import 统一异常处理器

异常处理器 = 统一异常处理器()

# 安全执行函数
成功, 结果, 错误 = 异常处理器.安全执行(危险函数, 参数1, 参数2)
if not 成功:
    print(f"执行失败: {错误}")
else:
    print(f"执行成功: {结果}")

# 获取异常统计
统计 = 异常处理器.获取异常统计()
print(f"异常统计: {统计}")
```

### 环境配置演示
```python
from config.配置管理器 import 配置管理器

配置管理器 = 配置管理器("./config/")

# 获取当前环境配置
当前配置 = 配置管理器.获取当前配置()
print(f"当前环境: {当前配置['环境']}")

# 手动切换环境
配置管理器.切换环境("production")
生产配置 = 配置管理器.获取当前配置()
```

### 性能优化演示
```python
from utils.性能监控 import 性能监控器
from utils.时间戳优化器 import 获取优化时间

监控器 = 性能监控器()

# 监控性能
with 监控器.监控操作("技能检测"):
    # 使用优化时间戳
    开始时间 = 获取优化时间()
    # 执行技能检测
    结束时间 = 获取优化时间()
    print(f"检测耗时: {结束时间 - 开始时间:.3f}s")

# 获取性能报告
报告 = 监控器.生成性能报告()
print(f"性能报告: {报告}")
```