#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
技能循环引擎 - 完整示例代码
演示如何集成和使用技能循环引擎
"""

import time
import os
from 技能循环引擎 import 技能循环引擎
from 技能循环引擎.interface.按键操作接口 import 按键操作接口
from 技能循环引擎.interface.图像获取接口 import 图像获取接口


class 示例按键适配器(按键操作接口):
    """
    示例按键适配器实现
    实际项目中需要替换为具体的按键实现
    """
    
    def 按下按键(self, 键值: int) -> bool:
        print(f"[按键] 按下按键: {键值}")
        return True
    
    def 释放按键(self, 键值: int) -> bool:
        print(f"[按键] 释放按键: {键值}")
        return True
    
    def 按下并释放(self, 键值: int) -> bool:
        print(f"[按键] 按下并释放: {键值}")
        return True
    
    def 释放所有按键(self) -> bool:
        print("[按键] 释放所有按键")
        return True


class 示例图像适配器(图像获取接口):
    """
    示例图像适配器实现
    实际项目中需要替换为具体的截图实现
    """
    
    def 获取屏幕区域(self, 区域: tuple):
        print(f"[图像] 获取屏幕区域: {区域}")
        # 返回模拟图像对象
        return MockImage()


class MockImage:
    """模拟图像对象，用于演示"""
    
    def getpixel(self, 坐标):
        # 模拟不同位置的像素值
        x, y = 坐标
        
        # 模拟技能图标颜色（根据坐标变化）
        if 100 <= x <= 200 and 100 <= y <= 200:
            return (255, 0, 0)  # 红色 - 技能可用
        elif 300 <= x <= 400 and 100 <= y <= 200:
            return (128, 128, 128)  # 灰色 - 技能冷却
        else:
            return (255, 255, 255)  # 白色 - 背景


def 演示基本用法():
    """演示技能循环引擎的基本用法"""
    print("=== 技能循环引擎演示 ===")
    
    # 创建适配器实例
    按键适配器 = 示例按键适配器()
    图像适配器 = 示例图像适配器()
    
    # 获取配置目录路径
    配置路径 = os.path.join(os.path.dirname(__file__), "config", "示例配置")
    
    # 创建引擎实例
    引擎 = 技能循环引擎(
        配置路径=配置路径,
        按键接口=按键适配器,
        图像接口=图像适配器
    )
    
    print(f"引擎创建成功，配置路径: {配置路径}")
    
    # 设置循环模式
    引擎.设置循环模式(1)  # 默认循环模式
    print("已设置默认循环模式")
    
    # 执行几次循环演示
    for i in range(5):
        print(f"\n--- 第 {i+1} 次循环 ---")
        
        # 执行一次技能循环
        成功 = 引擎.执行一次循环()
        
        if 成功:
            print("✓ 成功执行技能释放")
        else:
            print("✗ 没有可释放的技能")
        
        # 获取并显示引擎状态
        状态 = 引擎.获取当前状态()
        print(f"引擎状态: 模式={状态['当前模式']}, 执行次数={状态['执行次数']}")
        
        # 短暂延迟
        time.sleep(0.5)
    
    # 停止循环
    引擎.停止循环()
    print("\n=== 演示结束 ===")


def 演示模式切换():
    """演示模式切换功能"""
    print("\n=== 模式切换演示 ===")
    
    # 创建适配器实例
    按键适配器 = 示例按键适配器()
    图像适配器 = 示例图像适配器()
    
    # 创建引擎实例
    配置路径 = os.path.join(os.path.dirname(__file__), "config", "示例配置")
    引擎 = 技能循环引擎(配置路径, 按键适配器, 图像适配器)
    
    # 演示不同模式
    模式列表 = [
        (0, "未激活"),
        (1, "默认循环"),
        (2, "驱散循环"),
        (0, "停止")
    ]
    
    for 模式, 描述 in 模式列表:
        引擎.设置循环模式(模式)
        print(f"切换到模式 {模式}: {描述}")
        
        # 执行一次循环
        引擎.执行一次循环()
        time.sleep(0.3)


def 演示配置重载():
    """演示配置重载功能"""
    print("\n=== 配置重载演示 ===")
    
    # 创建适配器实例
    按键适配器 = 示例按键适配器()
    图像适配器 = 示例图像适配器()
    
    # 创建引擎实例
    配置路径 = os.path.join(os.path.dirname(__file__), "config", "示例配置")
    引擎 = 技能循环引擎(配置路径, 按键适配器, 图像适配器)
    
    # 获取初始配置
    初始状态 = 引擎.获取当前状态()
    print(f"初始配置: 检测区域={初始状态['检测区域']}")
    
    # 重载配置
    引擎.重新加载配置()
    print("✓ 配置重载完成")
    
    # 获取重载后的配置
    重载后状态 = 引擎.获取当前状态()
    print(f"重载后配置: 检测区域={重载后状态['检测区域']}")


if __name__ == "__main__":
    """运行示例代码"""
    
    print("技能循环引擎示例代码\n")
    
    try:
        # 演示基本用法
        演示基本用法()
        
        # 演示模式切换
        演示模式切换()
        
        # 演示配置重载
        演示配置重载()
        
        print("\n🎉 所有演示完成！")
        print("\n📝 使用说明:")
        print("1. 在实际项目中，需要替换示例适配器为具体实现")
        print("2. 根据实际游戏界面调整配置文件")
        print("3. 集成到主循环中持续运行")
        
    except Exception as e:
        print(f"\n❌ 演示过程中出现错误: {e}")
        print("请检查配置文件和依赖项")