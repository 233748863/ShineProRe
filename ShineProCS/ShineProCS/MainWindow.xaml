<Window x:Class="ShineProCS.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:ui="http://schemas.modernwpf.com/2019"
        xmlns:hc="https://handyorg.github.io/handycontrol"
        xmlns:local="clr-namespace:ShineProCS"
        mc:Ignorable="d"
        x:Name="RootWindow"
        Title="ShinePro C# WPF" Height="650" Width="1000"
        WindowStartupLocation="CenterScreen"
        ui:WindowHelper.UseModernWindowStyle="True"
        Background="{DynamicResource SystemControlPageBackgroundAltHighBrush}">

    <Window.Resources>
        <local:InverseBooleanConverter x:Key="InverseBooleanConverter"/>
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
        
        <ContextMenu x:Key="TrayMenu">
            <MenuItem Header="显示主界面" Click="ShowWindow_Click"/>
            <MenuItem Header="隐藏主界面" Click="HideWindow_Click"/>
            <Separator/>
            <MenuItem Header="启动引擎" Click="StartEngine_Click"/>
            <MenuItem Header="停止引擎" Click="StopEngine_Click"/>
            <Separator/>
            <MenuItem Header="退出程序" Click="ExitApp_Click"/>
        </ContextMenu>
    </Window.Resources>

    <Grid>
        <ui:NavigationView x:Name="RootNavigation"
                           PaneDisplayMode="Left"
                           IsBackButtonVisible="Collapsed"
                           IsSettingsVisible="False"
                           OpenPaneLength="180"
                           SelectionChanged="RootNavigation_SelectionChanged">
            
            <ui:NavigationView.Header>
                <TextBlock Text="ShinePro - 高级技能循环引擎" 
                           Style="{DynamicResource TitleTextBlockStyle}"
                           Margin="12,0,0,0" VerticalAlignment="Center" FontSize="24"/>
            </ui:NavigationView.Header>

            <ui:NavigationView.MenuItems>
                <ui:NavigationViewItem Content="运行状态" Tag="status" IsSelected="True">
                    <ui:NavigationViewItem.Icon>
                        <ui:SymbolIcon Symbol="Target" />
                    </ui:NavigationViewItem.Icon>
                </ui:NavigationViewItem>
                <ui:NavigationViewItem Content="技能配置" Tag="skills">
                    <ui:NavigationViewItem.Icon>
                        <ui:SymbolIcon Symbol="Favorite" />
                    </ui:NavigationViewItem.Icon>
                </ui:NavigationViewItem>
                <ui:NavigationViewItem Content="状态库" Tag="buffs">
                    <ui:NavigationViewItem.Icon>
                        <ui:SymbolIcon Symbol="Library" />
                    </ui:NavigationViewItem.Icon>
                </ui:NavigationViewItem>
                <ui:NavigationViewItem Content="全局设置" Tag="settings">
                    <ui:NavigationViewItem.Icon>
                        <ui:SymbolIcon Symbol="Setting" />
                    </ui:NavigationViewItem.Icon>
                </ui:NavigationViewItem>
            </ui:NavigationView.MenuItems>

            <ui:NavigationView.Content>
                <Grid Margin="16">
                    <!-- ========================================== -->
                    <!-- 页面 1: 运行状态 (Status) -->
                    <!-- ========================================== -->
                    <Grid x:Name="StatusPage">
                        <Grid.Style>
                            <Style TargetType="Grid">
                                <Setter Property="Visibility" Value="Collapsed"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding ElementName=RootNavigation, Path=SelectedItem.Tag}" Value="status">
                                        <Setter Property="Visibility" Value="Visible"/>
                                    </DataTrigger>
                                    <DataTrigger Binding="{Binding ElementName=RootNavigation, Path=SelectedItem}" Value="{x:Null}">
                                        <Setter Property="Visibility" Value="Visible"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Grid.Style>
                        
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="260"/>
                        </Grid.ColumnDefinitions>

                        <StackPanel Grid.Column="0" Margin="0,0,16,0">
                            <Border Background="{DynamicResource SystemControlBackgroundChromeMediumLowBrush}" 
                                    CornerRadius="8" Padding="20">
                                <StackPanel>
                                    <TextBlock Text="引擎运行指标" Style="{DynamicResource SubtitleTextBlockStyle}" Margin="0,0,0,16"/>
                                    <UniformGrid Columns="2">
                                        <StackPanel Margin="0,0,0,12">
                                            <TextBlock Text="当前模式" Style="{DynamicResource CaptionTextBlockStyle}" Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"/>
                                            <TextBlock Text="{Binding StatusText}" Style="{DynamicResource BodyTextBlockStyle}" FontWeight="Bold" FontSize="18" Foreground="{DynamicResource SystemControlHighlightAccentBrush}"/>
                                        </StackPanel>
                                        <StackPanel Margin="0,0,0,12">
                                            <TextBlock Text="执行次数" Style="{DynamicResource CaptionTextBlockStyle}" Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"/>
                                            <TextBlock Text="{Binding ExecutionCount}" Style="{DynamicResource BodyTextBlockStyle}" FontWeight="Bold" FontSize="18"/>
                                        </StackPanel>
                                        <StackPanel>
                                            <TextBlock Text="平均响应" Style="{DynamicResource CaptionTextBlockStyle}" Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"/>
                                            <TextBlock Text="{Binding AvgResponseTime, StringFormat={}{0:F4}s}" Style="{DynamicResource BodyTextBlockStyle}" FontWeight="Bold" FontSize="18"/>
                                        </StackPanel>
                                        <StackPanel>
                                            <TextBlock Text="成功率" Style="{DynamicResource CaptionTextBlockStyle}" Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"/>
                                            <TextBlock Text="{Binding SuccessRate, StringFormat={}{0:F1}%}" Style="{DynamicResource BodyTextBlockStyle}" FontWeight="Bold" FontSize="18" Foreground="#4CAF50"/>
                                        </StackPanel>
                                    </UniformGrid>
                                    
                                    <TextBlock Text="资源占用" Style="{DynamicResource BodyTextBlockStyle}" FontWeight="Bold" Margin="0,24,0,8"/>
                                    <ProgressBar Value="30" Height="4" Margin="0,0,0,8" />
                                    <TextBlock Text="{Binding MemoryStats}" Style="{DynamicResource CaptionTextBlockStyle}" Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"/>
                                </StackPanel>
                            </Border>
                        </StackPanel>

                        <Border Grid.Column="1" Background="{DynamicResource SystemControlBackgroundChromeMediumLowBrush}" 
                                CornerRadius="8" Padding="20" VerticalAlignment="Top">
                            <StackPanel>
                                <TextBlock Text="控制中心" Style="{DynamicResource SubtitleTextBlockStyle}" Margin="0,0,0,16"/>
                                <Button Content="启动引擎" 
                                        Command="{Binding DataContext.StartEngineCommand, ElementName=RootWindow}" 
                                        Style="{DynamicResource AccentButtonStyle}" Height="40" Margin="0,0,0,8" HorizontalAlignment="Stretch"
                                        IsEnabled="{Binding IsRunning, Converter={StaticResource InverseBooleanConverter}}"/>
                                
                                <Button Content="暂停/恢复" 
                                        Command="{Binding DataContext.PauseEngineCommand, ElementName=RootWindow}" 
                                        Height="40" Margin="0,0,0,8" HorizontalAlignment="Stretch"
                                        IsEnabled="{Binding IsRunning}"/>

                                <Button Content="停止引擎" 
                                        Command="{Binding DataContext.StopEngineCommand, ElementName=RootWindow}" 
                                        Height="40" Margin="0,0,0,8" HorizontalAlignment="Stretch"
                                        IsEnabled="{Binding IsRunning}"/>

                                <Button Content="深度清理内存" 
                                        Command="{Binding DataContext.ForceCleanupCommand, ElementName=RootWindow}" 
                                        Height="36" Margin="0,16,0,0" HorizontalAlignment="Stretch"/>
                            </StackPanel>
                        </Border>
                    </Grid>

                    <!-- ========================================== -->
                    <!-- 页面 2: 技能配置 (Skills) -->
                    <!-- ========================================== -->
                    <Grid x:Name="SkillsPage">
                        <Grid.Style>
                            <Style TargetType="Grid">
                                <Setter Property="Visibility" Value="Collapsed"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding ElementName=RootNavigation, Path=SelectedItem.Tag}" Value="skills">
                                        <Setter Property="Visibility" Value="Visible"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Grid.Style>
                        
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="260"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>

                        <!-- 技能列表 -->
                        <Border Grid.Column="0" Background="{DynamicResource SystemControlBackgroundChromeMediumLowBrush}" 
                                CornerRadius="8" Margin="0,0,16,0">
                            <DockPanel>
                                <StackPanel DockPanel.Dock="Top" Margin="16,16,16,8">
                                    <TextBlock Text="技能执行流程" Style="{DynamicResource SubtitleTextBlockStyle}" FontSize="18"/>
                                    <TextBlock Text="优先级：从上至下扫描" Style="{DynamicResource CaptionTextBlockStyle}" 
                                               Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" Margin="0,2,0,0"/>
                                </StackPanel>
                                
                                <StackPanel DockPanel.Dock="Bottom" Margin="8">
                                    <Grid Margin="0,0,0,4">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="*"/>
                                        </Grid.ColumnDefinitions>
                                        <Button Grid.Column="0" 
                                                   Command="{Binding DataContext.MoveSkillUpCommand, ElementName=RootWindow}" 
                                                   Margin="2" Height="32" HorizontalAlignment="Stretch">
                                            <Button.Content>
                                                <ui:SymbolIcon Symbol="Back" />
                                            </Button.Content>
                                        </Button>
                                        <Button Grid.Column="1" 
                                                   Command="{Binding DataContext.MoveSkillDownCommand, ElementName=RootWindow}" 
                                                   Margin="2" Height="32" HorizontalAlignment="Stretch">
                                            <Button.Content>
                                                <ui:SymbolIcon Symbol="Forward" />
                                            </Button.Content>
                                        </Button>
                                    </Grid>
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="*"/>
                                        </Grid.ColumnDefinitions>
                                        <Button Grid.Column="0" Content="添加" 
                                                   Command="{Binding DataContext.AddSkillCommand, ElementName=RootWindow}" 
                                                   Margin="2" Height="32" HorizontalAlignment="Stretch"/>
                                        <Button Grid.Column="1" Content="删除" 
                                                   Command="{Binding DataContext.DeleteSkillCommand, ElementName=RootWindow}" 
                                                   Margin="2" Height="32" HorizontalAlignment="Stretch"/>
                                    </Grid>
                                </StackPanel>

                                <ListBox ItemsSource="{Binding Skills}" SelectedItem="{Binding SelectedSkill}" 
                                         Background="Transparent" BorderThickness="0" Margin="4,0">
                                    <ListBox.ItemTemplate>
                                        <DataTemplate>
                                            <Grid Margin="0,2">
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="24"/>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="Auto"/>
                                                </Grid.ColumnDefinitions>
                                                <TextBlock Grid.Column="0" Text="{Binding RelativeSource={RelativeSource AncestorType=ListBoxItem}, Path=(ItemsControl.AlternationIndex), StringFormat={}{0}.}" 
                                                           VerticalAlignment="Center" Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" FontSize="12"/>
                                                <TextBlock Grid.Column="1" Text="{Binding Name}" VerticalAlignment="Center" FontWeight="SemiBold" FontSize="13"/>
                                                <Border Grid.Column="2" Background="{DynamicResource SystemControlBackgroundChromeLowBrush}" 
                                                        CornerRadius="4" Padding="4,1" Margin="4,0,0,0">
                                                    <TextBlock Text="{Binding KeyCode}" FontSize="10" VerticalAlignment="Center" Opacity="0.7"/>
                                                </Border>
                                            </Grid>
                                        </DataTemplate>
                                    </ListBox.ItemTemplate>
                                    <ListBox.AlternationCount>1000</ListBox.AlternationCount>
                                </ListBox>
                            </DockPanel>
                        </Border>

                        <!-- 技能详情 -->
                        <Border Grid.Column="1" Background="{DynamicResource SystemControlBackgroundChromeMediumLowBrush}" 
                                CornerRadius="8" Padding="20">
                            <ScrollViewer VerticalScrollBarVisibility="Auto">
                                <StackPanel DataContext="{Binding SelectedSkill}">
                                    <TextBlock Text="技能参数配置" Style="{DynamicResource SubtitleTextBlockStyle}" Margin="0,0,0,16" FontSize="18"/>
                                    
                                    <ui:SimpleStackPanel Spacing="8">
                                        <TextBox Text="{Binding Name}" ui:ControlHelper.Header="技能名称" />
                                        <TextBox Text="{Binding KeyCode}" ui:ControlHelper.Header="按键代码" />
                                        
                                        <TextBlock Text="视觉检测区域" Style="{DynamicResource BodyTextBlockStyle}" FontWeight="Bold" Margin="0,8,0,0"/>
                                        <UniformGrid Columns="4">
                                            <TextBox Text="{Binding IconRegion[0]}" ui:ControlHelper.Header="X" Margin="1"/>
                                            <TextBox Text="{Binding IconRegion[1]}" ui:ControlHelper.Header="Y" Margin="1"/>
                                            <TextBox Text="{Binding IconRegion[2]}" ui:ControlHelper.Header="W" Margin="1"/>
                                            <TextBox Text="{Binding IconRegion[3]}" ui:ControlHelper.Header="H" Margin="1"/>
                                        </UniformGrid>
                                        <Button Content="在屏幕上框选区域" 
                                                   Command="{Binding DataContext.SelectRegionCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                   CommandParameter="{Binding}" Height="36" HorizontalAlignment="Stretch"/>

                                        <TextBox Text="{Binding TemplatePath}" ui:ControlHelper.Header="模板文件路径"/>
                                        <Button Content="选择模板文件" 
                                                   Command="{Binding DataContext.SelectTemplateFileCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                   CommandParameter="{Binding}" Height="36" HorizontalAlignment="Stretch"/>
                                        
                                        <TextBlock Text="释放条件" Style="{DynamicResource BodyTextBlockStyle}" FontWeight="Bold" Margin="0,8,0,0"/>
                                        <UniformGrid Columns="2">
                                            <TextBox Text="{Binding MinHp}" ui:ControlHelper.Header="最低 HP %" Margin="1"/>
                                            <TextBox Text="{Binding MinMp}" ui:ControlHelper.Header="最低 MP %" Margin="1"/>
                                        </UniformGrid>

                                        <TextBlock Text="连招 (Combo) 配置" Style="{DynamicResource BodyTextBlockStyle}" FontWeight="Bold" Margin="0,8,0,0"/>
                                        <Border Background="{DynamicResource SystemControlBackgroundChromeLowBrush}" CornerRadius="4" Padding="12">
                                            <ui:SimpleStackPanel Spacing="8">
                                                <Grid>
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="*"/>
                                                        <ColumnDefinition Width="*"/>
                                                    </Grid.ColumnDefinitions>
                                                    <TextBox Text="{Binding PreCastKeyCode}" ui:ControlHelper.Header="前置技能 (VK)" Margin="0,0,4,0"/>
                                                    <TextBox Grid.Column="1" Text="{Binding PreCastConditionBuffName}" ui:ControlHelper.Header="触发 Buff 名 (缺失时触发)" Margin="4,0,0,0"/>
                                                </Grid>
                                                <Grid>
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="*"/>
                                                        <ColumnDefinition Width="*"/>
                                                    </Grid.ColumnDefinitions>
                                                    <TextBox Text="{Binding PostCastKeyCode}" ui:ControlHelper.Header="后置技能 (VK)" Margin="0,0,4,0"/>
                                                    <TextBox Grid.Column="1" Text="{Binding ComboDelay}" ui:ControlHelper.Header="连招延迟 (ms)" Margin="4,0,0,0"/>
                                                </Grid>
                                            </ui:SimpleStackPanel>
                                        </Border>
                                        
                                        <DockPanel Margin="0,8,0,0">
                                            <TextBlock Text="Buff/Debuff 视觉要求" Style="{DynamicResource BodyTextBlockStyle}" FontWeight="Bold" VerticalAlignment="Center"/>
                                            <Button Content="添加要求" 
                                                       Command="{Binding DataContext.AddBuffRequirementCommand, RelativeSource={RelativeSource AncestorType=Window}}" 
                                                       CommandParameter="{Binding}"
                                                       Height="32" HorizontalAlignment="Right"/>
                                        </DockPanel>

                                        <StackPanel Margin="0,8,0,0">
                                            <ItemsControl ItemsSource="{Binding BuffRequirements}" MinHeight="10">
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate>
                                                        <Border Background="{DynamicResource SystemControlBackgroundChromeLowBrush}" 
                                                                CornerRadius="4" Padding="12" Margin="0,0,0,8">
                                                            <ui:SimpleStackPanel Spacing="6">
                                                                <Grid>
                                                                    <Grid.ColumnDefinitions>
                                                                        <ColumnDefinition Width="*"/>
                                                                        <ColumnDefinition Width="Auto"/>
                                                                    </Grid.ColumnDefinitions>
                                                                    <TextBox Text="{Binding Name}" ui:ControlHelper.Header="Buff 名称" Margin="0,0,8,0"/>
                                                                    <Button Grid.Column="1" Content="删除" 
                                                                               Command="{Binding DataContext.DeleteBuffRequirementCommand, RelativeSource={RelativeSource AncestorType=Window}}" 
                                                                               CommandParameter="{Binding}" Height="32" VerticalAlignment="Bottom"/>
                                                                </Grid>

                                                                <UniformGrid Columns="2">
                                                                    <CheckBox IsChecked="{Binding IsRequired}" Content="必须满足" FontSize="12"/>
                                                                    <CheckBox IsChecked="{Binding IsDebuff}" Content="是减益" FontSize="12"/>
                                                                </UniformGrid>

                                                                <UniformGrid Columns="4">
                                                                    <TextBox Text="{Binding IconRegion[0]}" ui:ControlHelper.Header="X" Margin="1"/>
                                                                    <TextBox Text="{Binding IconRegion[1]}" ui:ControlHelper.Header="Y" Margin="1"/>
                                                                    <TextBox Text="{Binding IconRegion[2]}" ui:ControlHelper.Header="W" Margin="1"/>
                                                                    <TextBox Text="{Binding IconRegion[3]}" ui:ControlHelper.Header="H" Margin="1"/>
                                                                </UniformGrid>
                                                                
                                                                <Grid>
                                                                    <Grid.ColumnDefinitions>
                                                                        <ColumnDefinition Width="*"/>
                                                                        <ColumnDefinition Width="*"/>
                                                                    </Grid.ColumnDefinitions>
                                                                    <Button Grid.Column="0" Content="框选区域" 
                                                                               Command="{Binding DataContext.SelectRegionCommand, RelativeSource={RelativeSource AncestorType=Window}}" 
                                                                               CommandParameter="{Binding}" Margin="1" Height="32" HorizontalAlignment="Stretch"/>
                                                                    <Button Grid.Column="1" Content="选择模板" 
                                                                               Command="{Binding DataContext.SelectTemplateFileCommand, RelativeSource={RelativeSource AncestorType=Window}}" 
                                                                               CommandParameter="{Binding}" Margin="1" Height="32" HorizontalAlignment="Stretch"/>
                                                                </Grid>
                                                            </ui:SimpleStackPanel>
                                                        </Border>
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                            </ItemsControl>
                                        </StackPanel>

                                        <Button Content="保存当前配置" Style="{DynamicResource AccentButtonStyle}"
                                                   Command="{Binding DataContext.SaveConfigCommand, RelativeSource={RelativeSource AncestorType=Window}}" 
                                                   Margin="0,16,0,0" Height="40" HorizontalAlignment="Stretch"/>
                                    </ui:SimpleStackPanel>
                                </StackPanel>
                            </ScrollViewer>
                        </Border>
                    </Grid>

                    <!-- ========================================== -->
                    <!-- 页面 3: Buff 库 (Buffs) -->
                    <!-- ========================================== -->
                    <Grid x:Name="BuffLibraryPage">
                        <Grid.Style>
                            <Style TargetType="Grid">
                                <Setter Property="Visibility" Value="Collapsed"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding ElementName=RootNavigation, Path=SelectedItem.Tag}" Value="buffs">
                                        <Setter Property="Visibility" Value="Visible"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Grid.Style>

                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="260"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>

                        <!-- Buff 列表 -->
                        <Border Grid.Column="0" Background="{DynamicResource SystemControlBackgroundChromeMediumLowBrush}" 
                                CornerRadius="8" Margin="0,0,16,0">
                            <DockPanel>
                                <StackPanel DockPanel.Dock="Top" Margin="16,16,16,8">
                                    <TextBlock Text="全局状态库" Style="{DynamicResource SubtitleTextBlockStyle}" FontSize="18"/>
                                    <TextBlock Text="定义可被引用的视觉状态 (Buff/Debuff)" Style="{DynamicResource CaptionTextBlockStyle}" 
                                               Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" Margin="0,2,0,0"/>
                                </StackPanel>

                                <StackPanel DockPanel.Dock="Bottom" Margin="8">
                                    <Button Content="添加新状态" 
                                               Command="{Binding DataContext.AddGlobalBuffCommand, ElementName=RootWindow}" 
                                               Height="36" HorizontalAlignment="Stretch"/>
                                </StackPanel>

                                <ListBox x:Name="GlobalBuffList" ItemsSource="{Binding AppSettings.GlobalBuffs}" 
                                         Background="Transparent" BorderThickness="0" Margin="4,0">
                                    <ListBox.ItemTemplate>
                                        <DataTemplate>
                                            <StackPanel Orientation="Horizontal">
                                                <TextBlock Text="{Binding Name}" VerticalAlignment="Center" FontWeight="SemiBold" FontSize="14"/>
                                                <Border Visibility="{Binding IsDebuff, Converter={StaticResource BooleanToVisibilityConverter}}"
                                                        Background="#E57373" CornerRadius="4" Padding="4,1" Margin="8,0,0,0">
                                                    <TextBlock Text="Debuff" FontSize="10" Foreground="White" VerticalAlignment="Center"/>
                                                </Border>
                                            </StackPanel>
                                        </DataTemplate>
                                    </ListBox.ItemTemplate>
                                </ListBox>
                            </DockPanel>
                        </Border>

                        <!-- Buff 详情 -->
                        <Border Grid.Column="1" Background="{DynamicResource SystemControlBackgroundChromeMediumLowBrush}" 
                                CornerRadius="8" Padding="20">
                            <ScrollViewer VerticalScrollBarVisibility="Auto">
                                <StackPanel DataContext="{Binding ElementName=GlobalBuffList, Path=SelectedItem}">
                                    <StackPanel.Style>
                                        <Style TargetType="StackPanel">
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding}" Value="{x:Null}">
                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </StackPanel.Style>

                                    <TextBlock Text="状态视觉参数" Style="{DynamicResource SubtitleTextBlockStyle}" Margin="0,0,0,16" FontSize="18"/>
                                    
                                    <ui:SimpleStackPanel Spacing="12">
                                        <TextBox Text="{Binding Name}" ui:ControlHelper.Header="状态名称 (用于连招引用)" />
                                        
                                        <CheckBox IsChecked="{Binding IsDebuff}" Content="这是一个减益状态 (Debuff)" FontSize="14" FontWeight="Bold"/>
                                        
                                        <TextBlock Text="检测区域" Style="{DynamicResource BodyTextBlockStyle}" FontWeight="Bold" Margin="0,8,0,0"/>
                                        <UniformGrid Columns="4">
                                            <TextBox Text="{Binding IconRegion[0]}" ui:ControlHelper.Header="X" Margin="1"/>
                                            <TextBox Text="{Binding IconRegion[1]}" ui:ControlHelper.Header="Y" Margin="1"/>
                                            <TextBox Text="{Binding IconRegion[2]}" ui:ControlHelper.Header="W" Margin="1"/>
                                            <TextBox Text="{Binding IconRegion[3]}" ui:ControlHelper.Header="H" Margin="1"/>
                                        </UniformGrid>
                                        <Button Content="在屏幕上框选区域" 
                                                   Command="{Binding DataContext.SelectRegionCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                   CommandParameter="{Binding}" Height="36" HorizontalAlignment="Stretch"/>

                                        <TextBox Text="{Binding TemplatePath}" ui:ControlHelper.Header="模板图片路径"/>
                                        <Button Content="选择模板文件" 
                                                   Command="{Binding DataContext.SelectTemplateFileCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                   CommandParameter="{Binding}" Height="36" HorizontalAlignment="Stretch"/>
                                        
                                        <Slider Value="{Binding SimilarityThreshold}" Minimum="0.5" Maximum="1.0" TickFrequency="0.05" IsSnapToTickEnabled="True"
                                                ui:ControlHelper.Header="{Binding SimilarityThreshold, StringFormat=相似度阈值: {0:F2}}"/>

                                        <Button Content="删除此状态" 
                                                   Command="{Binding DataContext.DeleteGlobalBuffCommand, ElementName=RootWindow}" 
                                                   CommandParameter="{Binding}" Margin="0,24,0,0" HorizontalAlignment="Stretch"/>

                                        <Button Content="保存全局设置" Style="{DynamicResource AccentButtonStyle}"
                                                   Command="{Binding DataContext.SaveConfigCommand, RelativeSource={RelativeSource AncestorType=Window}}" 
                                                   Margin="0,12,0,0" Height="40" HorizontalAlignment="Stretch"/>
                                    </ui:SimpleStackPanel>
                                </StackPanel>
                            </ScrollViewer>
                        </Border>
                    </Grid>

                    <!-- ========================================== -->
                    <!-- 页面 4: 全局设置 (Settings) -->
                    <!-- ========================================== -->
                    <Grid x:Name="SettingsPage">
                        <Grid.Style>
                            <Style TargetType="Grid">
                                <Setter Property="Visibility" Value="Collapsed"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding ElementName=RootNavigation, Path=SelectedItem.Tag}" Value="settings">
                                        <Setter Property="Visibility" Value="Visible"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Grid.Style>
                        
                        <Border Background="{DynamicResource SystemControlBackgroundChromeMediumLowBrush}" 
                                CornerRadius="8" Padding="20" MaxWidth="500" HorizontalAlignment="Left" VerticalAlignment="Top">
                            <ui:SimpleStackPanel Spacing="12">
                                <TextBlock Text="全局引擎配置" Style="{DynamicResource SubtitleTextBlockStyle}" Margin="0,0,0,4" FontSize="18"/>
                                
                                <TextBox Text="{Binding AppSettings.LoopInterval}" ui:ControlHelper.Header="循环间隔 (ms)"/>
                                <ui:ToggleSwitch IsOn="{Binding AppSettings.EnableSmartMode}" Header="启用智能图像识别模式"/>
                                
                                <TextBlock Text="全局检测范围" Style="{DynamicResource BodyTextBlockStyle}" FontWeight="Bold" Margin="0,4,0,0"/>
                                <UniformGrid Columns="4">
                                    <TextBox Text="{Binding AppSettings.DetectionRegion[0]}" ui:ControlHelper.Header="X" Margin="1"/>
                                    <TextBox Text="{Binding AppSettings.DetectionRegion[1]}" ui:ControlHelper.Header="Y" Margin="1"/>
                                    <TextBox Text="{Binding AppSettings.DetectionRegion[2]}" ui:ControlHelper.Header="W" Margin="1"/>
                                    <TextBox Text="{Binding AppSettings.DetectionRegion[3]}" ui:ControlHelper.Header="H" Margin="1"/>
                                </UniformGrid>

                                <Button Content="保存全局设置" Style="{DynamicResource AccentButtonStyle}"
                                           Command="{Binding DataContext.SaveConfigCommand, RelativeSource={RelativeSource AncestorType=Window}}" 
                                           Margin="0,16,0,0" Height="40" HorizontalAlignment="Stretch"/>
                            </ui:SimpleStackPanel>
                        </Border>
                    </Grid>
                </Grid>
            </ui:NavigationView.Content>
        </ui:NavigationView>
    </Grid>
</Window>
