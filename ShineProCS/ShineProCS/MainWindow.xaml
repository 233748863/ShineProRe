<Window x:Class="ShineProCS.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:ui="http://schemas.modernwpf.com/2019"
        xmlns:hc="https://handyorg.github.io/handycontrol"
        xmlns:local="clr-namespace:ShineProCS"
        mc:Ignorable="d"
        x:Name="RootWindow"
        Title="ShinePro C# WPF" Height="750" Width="1150"
        WindowStartupLocation="CenterScreen"
        ui:WindowHelper.UseModernWindowStyle="True"
        Background="{DynamicResource SystemControlPageBackgroundAltHighBrush}">

    <Window.Resources>
        <local:InverseBooleanConverter x:Key="InverseBooleanConverter"/>
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
        
        <ContextMenu x:Key="TrayMenu">
            <MenuItem Header="显示主界面" Click="ShowWindow_Click"/>
            <MenuItem Header="隐藏主界面" Click="HideWindow_Click"/>
            <Separator/>
            <MenuItem Header="启动引擎" Click="StartEngine_Click"/>
            <MenuItem Header="停止引擎" Click="StopEngine_Click"/>
            <Separator/>
            <MenuItem Header="退出程序" Click="ExitApp_Click"/>
        </ContextMenu>
    </Window.Resources>

    <Grid>
        <ui:NavigationView x:Name="RootNavigation"
                           PaneDisplayMode="Left"
                           IsBackButtonVisible="Collapsed"
                           IsSettingsVisible="False"
                           OpenPaneLength="200"
                           SelectionChanged="RootNavigation_SelectionChanged">
            
            <ui:NavigationView.Header>
                <TextBlock Text="ShinePro - 高级技能循环引擎" 
                           Style="{DynamicResource TitleTextBlockStyle}"
                           Margin="12,0,0,0" VerticalAlignment="Center"/>
            </ui:NavigationView.Header>

            <ui:NavigationView.MenuItems>
                <ui:NavigationViewItem Content="运行状态" Tag="status" IsSelected="True">
                    <ui:NavigationViewItem.Icon>
                        <ui:SymbolIcon Symbol="Target" />
                    </ui:NavigationViewItem.Icon>
                </ui:NavigationViewItem>
                <ui:NavigationViewItem Content="技能配置" Tag="skills">
                    <ui:NavigationViewItem.Icon>
                        <ui:SymbolIcon Symbol="Favorite" />
                    </ui:NavigationViewItem.Icon>
                </ui:NavigationViewItem>
                <ui:NavigationViewItem Content="全局设置" Tag="settings">
                    <ui:NavigationViewItem.Icon>
                        <ui:SymbolIcon Symbol="Setting" />
                    </ui:NavigationViewItem.Icon>
                </ui:NavigationViewItem>
            </ui:NavigationView.MenuItems>

            <ui:NavigationView.Content>
                <Grid Margin="24">
                    <!-- ========================================== -->
                    <!-- 页面 1: 运行状态 (Status) -->
                    <!-- ========================================== -->
                    <Grid x:Name="StatusPage">
                        <Grid.Style>
                            <Style TargetType="Grid">
                                <Setter Property="Visibility" Value="Collapsed"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding ElementName=RootNavigation, Path=SelectedItem.Tag}" Value="status">
                                        <Setter Property="Visibility" Value="Visible"/>
                                    </DataTrigger>
                                    <DataTrigger Binding="{Binding ElementName=RootNavigation, Path=SelectedItem}" Value="{x:Null}">
                                        <Setter Property="Visibility" Value="Visible"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Grid.Style>
                        
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="320"/>
                        </Grid.ColumnDefinitions>

                        <StackPanel Grid.Column="0" Margin="0,0,20,0">
                            <Border Background="{DynamicResource SystemControlBackgroundChromeMediumLowBrush}" 
                                    CornerRadius="8" Padding="24">
                                <StackPanel>
                                    <TextBlock Text="引擎运行指标" Style="{DynamicResource SubtitleTextBlockStyle}" Margin="0,0,0,24"/>
                                    <UniformGrid Columns="2">
                                        <StackPanel Margin="0,0,0,16">
                                            <TextBlock Text="当前模式" Style="{DynamicResource CaptionTextBlockStyle}" Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"/>
                                            <TextBlock Text="{Binding StatusText}" Style="{DynamicResource BodyTextBlockStyle}" FontWeight="Bold" FontSize="20" Foreground="{DynamicResource SystemControlHighlightAccentBrush}"/>
                                        </StackPanel>
                                        <StackPanel Margin="0,0,0,16">
                                            <TextBlock Text="执行次数" Style="{DynamicResource CaptionTextBlockStyle}" Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"/>
                                            <TextBlock Text="{Binding ExecutionCount}" Style="{DynamicResource BodyTextBlockStyle}" FontWeight="Bold" FontSize="20"/>
                                        </StackPanel>
                                        <StackPanel>
                                            <TextBlock Text="平均响应" Style="{DynamicResource CaptionTextBlockStyle}" Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"/>
                                            <TextBlock Text="{Binding AvgResponseTime, StringFormat={}{0:F4}s}" Style="{DynamicResource BodyTextBlockStyle}" FontWeight="Bold" FontSize="20"/>
                                        </StackPanel>
                                        <StackPanel>
                                            <TextBlock Text="成功率" Style="{DynamicResource CaptionTextBlockStyle}" Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"/>
                                            <TextBlock Text="{Binding SuccessRate, StringFormat={}{0:F1}%}" Style="{DynamicResource BodyTextBlockStyle}" FontWeight="Bold" FontSize="20" Foreground="#4CAF50"/>
                                        </StackPanel>
                                    </UniformGrid>
                                    
                                    <TextBlock Text="资源占用" Style="{DynamicResource BodyTextBlockStyle}" FontWeight="Bold" Margin="0,32,0,12"/>
                                    <ProgressBar Value="30" Height="4" Margin="0,0,0,12" />
                                    <TextBlock Text="{Binding MemoryStats}" Style="{DynamicResource CaptionTextBlockStyle}" Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"/>
                                </StackPanel>
                            </Border>
                        </StackPanel>

                        <Border Grid.Column="1" Background="{DynamicResource SystemControlBackgroundChromeMediumLowBrush}" 
                                CornerRadius="8" Padding="24" VerticalAlignment="Top">
                            <StackPanel>
                                <TextBlock Text="控制中心" Style="{DynamicResource SubtitleTextBlockStyle}" Margin="0,0,0,24"/>
                                <Button Content="启动引擎" 
                                        Command="{Binding DataContext.StartEngineCommand, ElementName=RootWindow}" 
                                        Style="{DynamicResource AccentButtonStyle}" Height="48" Margin="0,0,0,12" HorizontalAlignment="Stretch"
                                        IsEnabled="{Binding IsRunning, Converter={StaticResource InverseBooleanConverter}}"/>
                                
                                <Button Content="暂停/恢复" 
                                        Command="{Binding DataContext.PauseEngineCommand, ElementName=RootWindow}" 
                                        Height="48" Margin="0,0,0,12" HorizontalAlignment="Stretch"
                                        IsEnabled="{Binding IsRunning}"/>

                                <Button Content="停止引擎" 
                                        Command="{Binding DataContext.StopEngineCommand, ElementName=RootWindow}" 
                                        Height="48" Margin="0,0,0,12" HorizontalAlignment="Stretch"
                                        IsEnabled="{Binding IsRunning}"/>

                                <Button Content="深度清理内存" 
                                        Command="{Binding DataContext.ForceCleanupCommand, ElementName=RootWindow}" 
                                        Margin="0,24,0,0" HorizontalAlignment="Stretch"/>
                            </StackPanel>
                        </Border>
                    </Grid>

                    <!-- ========================================== -->
                    <!-- 页面 2: 技能配置 (Skills) -->
                    <!-- ========================================== -->
                    <Grid x:Name="SkillsPage">
                        <Grid.Style>
                            <Style TargetType="Grid">
                                <Setter Property="Visibility" Value="Collapsed"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding ElementName=RootNavigation, Path=SelectedItem.Tag}" Value="skills">
                                        <Setter Property="Visibility" Value="Visible"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Grid.Style>
                        
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="350"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>

                        <!-- 技能列表 (增强可视化) -->
                        <Border Grid.Column="0" Background="{DynamicResource SystemControlBackgroundChromeMediumLowBrush}" 
                                CornerRadius="8" Margin="0,0,20,0">
                            <DockPanel>
                                <StackPanel DockPanel.Dock="Top" Margin="20,20,20,12">
                                    <TextBlock Text="技能执行流程" Style="{DynamicResource SubtitleTextBlockStyle}"/>
                                    <TextBlock Text="优先级：从上至下扫描" Style="{DynamicResource CaptionTextBlockStyle}" 
                                               Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" Margin="0,4,0,0"/>
                                </StackPanel>
                                
                                <StackPanel DockPanel.Dock="Bottom" Margin="12">
                                    <Grid Margin="0,0,0,8">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="*"/>
                                        </Grid.ColumnDefinitions>
                                        <Button Grid.Column="0" 
                                                   Command="{Binding DataContext.MoveSkillUpCommand, ElementName=RootWindow}" 
                                                   Margin="4" HorizontalAlignment="Stretch">
                                            <Button.Content>
                                                <ui:SymbolIcon Symbol="Back" />
                                            </Button.Content>
                                        </Button>
                                        <Button Grid.Column="1" 
                                                   Command="{Binding DataContext.MoveSkillDownCommand, ElementName=RootWindow}" 
                                                   Margin="4" HorizontalAlignment="Stretch">
                                            <Button.Content>
                                                <ui:SymbolIcon Symbol="Forward" />
                                            </Button.Content>
                                        </Button>
                                    </Grid>
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="*"/>
                                        </Grid.ColumnDefinitions>
                                        <Button Grid.Column="0" Content="添加技能" 
                                                   Command="{Binding DataContext.AddSkillCommand, ElementName=RootWindow}" 
                                                   Margin="4" HorizontalAlignment="Stretch"/>
                                        <Button Grid.Column="1" Content="删除技能" 
                                                   Command="{Binding DataContext.DeleteSkillCommand, ElementName=RootWindow}" 
                                                   Margin="4" HorizontalAlignment="Stretch"/>
                                    </Grid>
                                </StackPanel>

                                <ListBox ItemsSource="{Binding Skills}" SelectedItem="{Binding SelectedSkill}" 
                                         Background="Transparent" BorderThickness="0" Margin="8,0">
                                    <ListBox.ItemTemplate>
                                        <DataTemplate>
                                            <Grid Margin="0,4">
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="30"/>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="Auto"/>
                                                </Grid.ColumnDefinitions>
                                                
                                                <!-- 序号 -->
                                                <TextBlock Grid.Column="0" Text="{Binding RelativeSource={RelativeSource AncestorType=ListBoxItem}, Path=(ItemsControl.AlternationIndex), StringFormat={}{0}.}" 
                                                           VerticalAlignment="Center" Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"/>
                                                
                                                <!-- 技能名 -->
                                                <TextBlock Grid.Column="1" Text="{Binding Name}" VerticalAlignment="Center" FontWeight="SemiBold"/>
                                                
                                                <!-- 按键预览 -->
                                                <Border Grid.Column="2" Background="{DynamicResource SystemControlBackgroundChromeLowBrush}" 
                                                        CornerRadius="4" Padding="6,2" Margin="8,0,0,0">
                                                    <TextBlock Text="{Binding KeyCode}" FontSize="11" VerticalAlignment="Center" Opacity="0.8"/>
                                                </Border>
                                            </Grid>
                                        </DataTemplate>
                                    </ListBox.ItemTemplate>
                                    <!-- 启用 AlternationIndex 用于显示序号 -->
                                    <ListBox.AlternationCount>1000</ListBox.AlternationCount>
                                </ListBox>
                            </DockPanel>
                        </Border>

                        <!-- 技能详情 -->
                        <Border Grid.Column="1" Background="{DynamicResource SystemControlBackgroundChromeMediumLowBrush}" 
                                CornerRadius="8" Padding="24">
                            <ScrollViewer>
                                <StackPanel DataContext="{Binding SelectedSkill}">
                                    <TextBlock Text="技能参数配置" Style="{DynamicResource SubtitleTextBlockStyle}" Margin="0,0,0,24"/>
                                    
                                    <ui:SimpleStackPanel Spacing="12">
                                        <TextBox Text="{Binding Name}" ui:ControlHelper.Header="技能名称" />
                                        <TextBox Text="{Binding KeyCode}" ui:ControlHelper.Header="按键代码 (Virtual Key Code)" />
                                        
                                        <TextBlock Text="视觉检测区域 (满足此图像才释放)" Style="{DynamicResource BodyTextBlockStyle}" FontWeight="Bold" Margin="0,12,0,0"/>
                                        <UniformGrid Columns="4">
                                            <TextBox Text="{Binding IconRegion[0]}" ui:ControlHelper.Header="X" Margin="2"/>
                                            <TextBox Text="{Binding IconRegion[1]}" ui:ControlHelper.Header="Y" Margin="2"/>
                                            <TextBox Text="{Binding IconRegion[2]}" ui:ControlHelper.Header="W" Margin="2"/>
                                            <TextBox Text="{Binding IconRegion[3]}" ui:ControlHelper.Header="H" Margin="2"/>
                                        </UniformGrid>
                                        <Button Content="在屏幕上框选区域" 
                                                   Command="{Binding DataContext.SelectRegionCommand, ElementName=RootWindow}"
                                                   CommandParameter="{Binding}" HorizontalAlignment="Stretch"/>

                                        <TextBox Text="{Binding TemplatePath}" ui:ControlHelper.Header="模板文件路径"/>
                                        <Button Content="选择模板文件" 
                                                   Command="{Binding DataContext.SelectTemplateFileCommand, ElementName=RootWindow}"
                                                   CommandParameter="{Binding}" HorizontalAlignment="Stretch"/>
                                        
                                        <TextBlock Text="释放条件 (数值要求)" Style="{DynamicResource BodyTextBlockStyle}" FontWeight="Bold" Margin="0,12,0,0"/>
                                        <UniformGrid Columns="2">
                                            <TextBox Text="{Binding MinHp}" ui:ControlHelper.Header="最低 HP %" Margin="2"/>
                                            <TextBox Text="{Binding MinMp}" ui:ControlHelper.Header="最低 MP %" Margin="2"/>
                                        </UniformGrid>
                                        
                                        <DockPanel Margin="0,12,0,0">
                                            <TextBlock Text="Buff/Debuff 视觉要求" Style="{DynamicResource BodyTextBlockStyle}" FontWeight="Bold" VerticalAlignment="Center"/>
                                            <Button Content="添加要求" 
                                                       Command="{Binding DataContext.AddBuffRequirementCommand, ElementName=RootWindow}" 
                                                       HorizontalAlignment="Right"/>
                                        </DockPanel>

                                        <ItemsControl ItemsSource="{Binding BuffRequirements}">
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <Border Background="{DynamicResource SystemControlBackgroundChromeLowBrush}" 
                                                            CornerRadius="4" Padding="16" Margin="0,0,0,12">
                                                        <ui:SimpleStackPanel Spacing="8">
                                                            <Grid>
                                                                <Grid.ColumnDefinitions>
                                                                    <ColumnDefinition Width="*"/>
                                                                    <ColumnDefinition Width="Auto"/>
                                                                </Grid.ColumnDefinitions>
                                                                <TextBox Text="{Binding Name}" ui:ControlHelper.Header="Buff 名称" Margin="0,0,8,0"/>
                                                                <Button Grid.Column="1" Content="删除" 
                                                                           Command="{Binding DataContext.DeleteBuffRequirementCommand, ElementName=RootWindow}" 
                                                                           CommandParameter="{Binding}" VerticalAlignment="Bottom"/>
                                                            </Grid>

                                                            <UniformGrid Columns="2">
                                                                <CheckBox IsChecked="{Binding IsRequired}" Content="必须满足"/>
                                                                <CheckBox IsChecked="{Binding IsDebuff}" Content="是减益(Debuff)"/>
                                                            </UniformGrid>

                                                            <UniformGrid Columns="4">
                                                                <TextBox Text="{Binding IconRegion[0]}" ui:ControlHelper.Header="X" Margin="1"/>
                                                                <TextBox Text="{Binding IconRegion[1]}" ui:ControlHelper.Header="Y" Margin="1"/>
                                                                <TextBox Text="{Binding IconRegion[2]}" ui:ControlHelper.Header="W" Margin="1"/>
                                                                <TextBox Text="{Binding IconRegion[3]}" ui:ControlHelper.Header="H" Margin="1"/>
                                                            </UniformGrid>
                                                            
                                                            <Grid>
                                                                <Grid.ColumnDefinitions>
                                                                    <ColumnDefinition Width="*"/>
                                                                    <ColumnDefinition Width="*"/>
                                                                </Grid.ColumnDefinitions>
                                                                <Button Grid.Column="0" Content="框选区域" 
                                                                           Command="{Binding DataContext.SelectRegionCommand, ElementName=RootWindow}" 
                                                                           CommandParameter="{Binding}" Margin="2" HorizontalAlignment="Stretch"/>
                                                                <Button Grid.Column="1" Content="选择模板" 
                                                                           Command="{Binding DataContext.SelectTemplateFileCommand, ElementName=RootWindow}" 
                                                                           CommandParameter="{Binding}" Margin="2" HorizontalAlignment="Stretch"/>
                                                            </Grid>
                                                        </ui:SimpleStackPanel>
                                                    </Border>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>

                                        <Button Content="保存当前配置" Style="{DynamicResource AccentButtonStyle}"
                                                   Command="{Binding DataContext.SaveConfigCommand, ElementName=RootWindow}" 
                                                   Margin="0,24,0,0" Height="48" HorizontalAlignment="Stretch"/>
                                    </ui:SimpleStackPanel>
                                </StackPanel>
                            </ScrollViewer>
                        </Border>
                    </Grid>

                    <!-- ========================================== -->
                    <!-- 页面 3: 全局设置 (Settings) -->
                    <!-- ========================================== -->
                    <Grid x:Name="SettingsPage">
                        <Grid.Style>
                            <Style TargetType="Grid">
                                <Setter Property="Visibility" Value="Collapsed"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding ElementName=RootNavigation, Path=SelectedItem.Tag}" Value="settings">
                                        <Setter Property="Visibility" Value="Visible"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Grid.Style>
                        
                        <Border Background="{DynamicResource SystemControlBackgroundChromeMediumLowBrush}" 
                                CornerRadius="8" Padding="24" MaxWidth="600" HorizontalAlignment="Left" VerticalAlignment="Top">
                            <ui:SimpleStackPanel Spacing="16">
                                <TextBlock Text="全局引擎配置" Style="{DynamicResource SubtitleTextBlockStyle}" Margin="0,0,0,8"/>
                                
                                <TextBox Text="{Binding AppSettings.LoopInterval}" ui:ControlHelper.Header="循环间隔 (ms)"/>
                                <ui:ToggleSwitch IsOn="{Binding AppSettings.EnableSmartMode}" Header="启用智能图像识别模式"/>
                                
                                <TextBlock Text="全局检测范围" Style="{DynamicResource BodyTextBlockStyle}" FontWeight="Bold" Margin="0,8,0,0"/>
                                <UniformGrid Columns="4">
                                    <TextBox Text="{Binding AppSettings.DetectionRegion[0]}" ui:ControlHelper.Header="X" Margin="2"/>
                                    <TextBox Text="{Binding AppSettings.DetectionRegion[1]}" ui:ControlHelper.Header="Y" Margin="2"/>
                                    <TextBox Text="{Binding AppSettings.DetectionRegion[2]}" ui:ControlHelper.Header="W" Margin="2"/>
                                    <TextBox Text="{Binding AppSettings.DetectionRegion[3]}" ui:ControlHelper.Header="H" Margin="2"/>
                                </UniformGrid>

                                <Button Content="保存全局设置" Style="{DynamicResource AccentButtonStyle}"
                                           Command="{Binding DataContext.SaveConfigCommand, ElementName=RootWindow}" 
                                           Margin="0,24,0,0" Height="48" HorizontalAlignment="Stretch"/>
                            </ui:SimpleStackPanel>
                        </Border>
                    </Grid>
                </Grid>
            </ui:NavigationView.Content>
        </ui:NavigationView>
    </Grid>
</Window>
