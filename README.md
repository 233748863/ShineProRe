# 技能循环引擎 🎮

一个基于**现代化软件架构**的技能循环释放引擎，采用**依赖注入**和**策略模式**设计，具备高度模块化、可扩展、安全可靠的特性。

## ✨ 核心特性（增强版）

### 🏗️ 现代化架构
- **依赖注入容器** - 类型安全的依赖管理
- **策略模式系统** - 支持运行时算法切换
- **插件化设计** - 易于扩展新功能
- **环境配置管理** - 开发/生产环境自动切换

### 🔒 安全可靠
- **统一异常处理** - 智能异常分类和重试机制
- **权限控制系统** - 操作权限和频率限制
- **性能监控体系** - 实时性能统计和报告
- **配置验证系统** - 自动配置完整性检查

### ⚡ 高效智能
- **时间戳优化器** - 减少系统调用开销
- **统一缓存管理** - 多级缓存策略优化
- **智能决策算法** - 基于优先级的技能选择
- **配置热重载** - 运行时配置更新
- **滑动窗口统计** - O(1)复杂度的实时统计

### 🔧 易于集成
- **接口抽象设计** - 支持多种实现适配
- **详细文档支持** - 完整的API和开发指南
- **示例代码丰富** - 快速上手集成
- **环境适配性** - 自动环境检测和配置加载

## 目录结构

```
技能循环引擎/
├── core/                    # 核心逻辑模块
│   ├── 技能状态检测器.py     # 技能状态颜色检测
│   ├── 技能决策引擎.py       # 技能优先级决策算法
│   ├── 技能循环策略.py       # 策略模式接口
│   ├── 策略接口.py           # 策略管理器
│   └── 依赖容器.py           # 依赖注入容器
├── interface/              # 抽象接口定义
│   ├── 按键操作接口.py
│   ├── 图像获取接口.py
│   └── 事件监听接口.py
├── config/                 # 配置管理
│   ├── 配置管理器.py         # 增强的配置管理器
│   ├── 配置.development.json # 开发环境配置
│   ├── 配置.production.json  # 生产环境配置
│   └── opencv_技能配置.json  # OpenCV配置示例
├── utils/                  # 工具类
│   ├── 颜色判断工具.py
│   ├── 性能监控.py           # 性能监控系统
│   ├── 异常隔离.py           # 统一异常处理
│   ├── 权限控制.py           # 权限管理系统
│   ├── 配置监听器.py         # 配置热重载
│   ├── 日志管理.py           # 日志管理系统
│   ├── 调试工具.py           # 调试支持工具
│   ├── 统一缓存管理器.py     # 缓存管理系统
│   ├── 时间戳优化器.py       # 性能优化工具
│   └── 异步处理.py           # 异步处理工具
├── 技能循环引擎.py          # 主引擎入口
├── 示例代码_增强版.py        # 增强版示例代码
├── 示例代码.py               # 基础示例代码
└── README.md
```

## 快速开始（增强版）

### 1. 实现适配器接口

```python
from interface.按键操作接口 import 按键操作接口
from interface.图像获取接口 import 图像获取接口

class 我的按键适配器(按键操作接口):
    def 按下并释放(self, 键值: int) -> bool:
        # 调用你的具体按键实现
        return my_keyboard.press(键值)

class 我的图像适配器(图像获取接口):
    def 获取屏幕区域(self, 区域: tuple):
        # 调用你的截图实现
        return my_screenshot.capture(区域)
```

### 2. 创建引擎实例（支持环境配置）

```python
from 技能循环引擎 import 技能循环引擎

# 基础用法
引擎 = 技能循环引擎(
    配置路径="./config/",
    按键接口=我的按键适配器(),
    图像接口=我的图像适配器()
)

# 增强用法（指定环境）
引擎 = 技能循环引擎(
    配置路径="./config/",
    按键接口=我的按键适配器(),
    图像接口=我的图像适配器(),
    环境="development"  # 可选：development/production
)
```

### 3. 使用引擎（增强功能）

```python
# 设置循环模式 (1=默认循环, 2=驱散循环)
引擎.设置循环模式(1)

# 启用统一异常处理
引擎.启用统一异常处理()

# 启用配置热重载
引擎.开始配置监听()

# 安全执行技能循环
for i in range(100):
    成功, 错误信息 = 引擎.安全执行一次循环()
    if not 成功:
        print(f"第{i}次循环失败: {错误信息}")

# 获取性能报告
性能报告 = 引擎.获取性能报告()
print(f"性能报告: {性能报告}")

# 获取异常统计
异常统计 = 引擎.获取异常统计()
print(f"异常统计: {异常统计}")
```

## 配置说明（增强版）

### 环境配置系统
项目现在支持环境特定的配置文件：
- `配置.development.json` - 开发环境配置
- `配置.production.json` - 生产环境配置
- 自动检测当前环境（通过环境变量或系统设置）

### 配置特性
- **配置验证**：自动验证配置格式和完整性
- **配置热重载**：运行时配置更新
- **配置备份恢复**：配置版本控制和回滚
- **配置变更回调**：配置变更时的回调机制

### 配置示例
```json
{
  "检测区域": [x1, y1, x2, y2],
  "蓝条配置": [x1, y1, x2, y2],
  "自动选人键值": 0,
  "环境": "development",
  "异常处理": {
    "启用重试机制": true,
    "最大重试次数": 3,
    "重试间隔": 1.0
  },
  "性能优化": {
    "启用缓存": true,
    "缓存有效期": 0.1,
    "采样间隔": 0.01
  }
}
```

## 依赖说明

核心逻辑无外部依赖，仅需实现以下接口：
- 按键操作接口
- 图像获取接口
- 事件监听接口（可选）

### 推荐依赖（用于增强功能）
```bash
# Python版本
Python >= 3.8

# 核心依赖
opencv-python >= 4.5.0
pynput >= 1.7.0
watchdog >= 2.0.0

# 增强功能依赖
numpy >= 1.21.0
Pillow >= 8.3.0
```

## 移植指南（增强版）

1. 复制整个`技能循环引擎`文件夹到新项目
2. 实现适配器接口
3. 提供配置文件（包括环境配置）
4. 集成使用引擎（推荐使用增强版功能）
5. 配置异常处理策略
6. 设置性能监控参数

## 新增功能演示

### 统一异常处理
```python
from utils.异常隔离 import 统一异常处理器

异常处理器 = 统一异常处理器()

# 安全执行函数
成功, 结果, 错误 = 异常处理器.安全执行(危险函数, 参数1, 参数2)
if not 成功:
    print(f"执行失败: {错误}")
else:
    print(f"执行成功: {结果}")
```

### 环境配置管理
```python
from config.配置管理器 import 配置管理器

配置管理器 = 配置管理器("./config/")
当前配置 = 配置管理器.获取当前配置()
print(f"当前环境: {当前配置['环境']}")
```

### 性能优化
```python
from utils.时间戳优化器 import 获取优化时间

# 使用优化时间戳
开始时间 = 获取优化时间()
# 执行操作
结束时间 = 获取优化时间()
print(f"操作耗时: {结束时间 - 开始时间:.3f}s")
```

## 文档资源

- **快速使用指南**：`docs/快速使用指南.md`
- **开发人员指南**：`docs/开发人员指南.md`
- **API参考文档**：`docs/API参考文档.md`
- **架构设计说明**：`docs/架构设计说明.md`
- **性能优化报告**：`docs/性能优化报告.md`

## 许可证

MIT License